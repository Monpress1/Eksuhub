<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eksu Hub News</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "d0551ffa-5bef-44c4-a74f-0a586ef17795",
    });
  });
</script>
    <style>
     /* ==================================== */
/* --- Root Variables & Base Styling --- */
/* ==================================== */
:root {
    --primary-color: #1f3b7d; /* Deep Blue (Marketplace color) */
    --secondary-color: #ff8c00; /* Orange */
    --bg-color: #f4f7f9;
    --card-bg: #ffffff;
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.1);
    --border-radius: 12px;
    --border-orangered: 1px solid orangered; /* Orangered border variable */
}

body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--bg-color);
    padding-bottom: 60px; /* Space for bottom nav */
}

/* ==================================== */
/* --- Modern Straight Header (Blue) --- */
/* ==================================== */
.header {
    background-color: var(--primary-color); /* Kept Primary Blue as requested */
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-medium);
    position: relative;
    z-index: 10;
    height: 50px;
    border-bottom: 3px solid var(--secondary-color);
    clip-path: none;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.header h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.header-logo-icon {
    font-size: 1.5rem;
    color: var(--secondary-color);
}

.back-btn {
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    text-decoration: none;
    padding-right: 10px;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
}

/* ==================================== */
/* --- Slideshow Styling (Updated) --- */
/* ==================================== */
.trending-label {
    font-size: 0.8rem;
    font-weight: bold;
    color: var(--secondary-color);
    text-transform: uppercase;
    padding: 5px 10px;
    margin-top: 15px;
    display: inline-block;
    background-color: #fff3e0;
    border-radius: 5px;
}

.slideshow-container {
    margin: 10px 0 20px 0;
    padding: 0 10px;
    overflow: hidden;
    position: relative;
    /* NEW: Box shadow for the container */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius); /* Rounded the container edge */
}
.slideshow {
    display: flex;
    transition: transform 0.5s ease-in-out;
    width: 100%;
}
.slide {
    flex: 0 0 100%;
    padding: 12px;
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    /* border: var(--border-orangered); (Removed) */
    border: 1px solid #eee; /* Added a subtle border */
    display: flex;
    align-items: center;
    gap: 12px;
    overflow: hidden;
    
    /* === FIX: Remove the line/underline from the link text === */
    text-decoration: none; 
    color: inherit; /* Ensure text color is inherited properly */
}
.slide img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
}
.slide-content {
    flex-grow: 1; /* Allow content to take available space */
    min-width: 0; /* Fix flex-item overflow */
}
.slide-content h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--primary-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.slide-content p {
    margin: 0;
    font-size: 0.8rem;
    color: #666;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Styling for the comments on the slide */
.slide-meta {
    margin-top: 5px;
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    color: #999;
    gap: 10px;
}

/* Demarcation Line */
.demarcation-line {
    border: 0;
    height: 1px;
    background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
    margin: 20px 0;
}

/* ==================================== */
/* --- Article List & Card Styling --- */
/* ==================================== */
.article-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 30px;
}

.article-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    border: 1px solid #eee;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    height: 100%;
    display: flex;
    flex-direction: column;
}
.article-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}
.article-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background-color: #e0e0e0;
}
.article-content {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}
.article-content h2 {
    margin-top: 0;
    font-size: 1.5em;
    color: #333;
    line-height: 1.2;
}
.article-content p {
    color: #555;
    font-size: 1em;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 15px;
}

/* ==================================== */
/* --- Article Card Interaction Styling --- */
/* ==================================== */
.meta {
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    color: #999;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.interaction-bar {
    display: flex;
    gap: 15px;
    align-items: center;
}

.interaction-item {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    color: #6c757d;
    text-decoration: none;
    font-weight: 500;
}

.interaction-item:hover {
    color: var(--primary-color);
}

.like-button.liked {
    color: #ff0055;
    pointer-events: none;
}

.like-count,
.comment-count {
    font-size: 0.9em;
}

.share-button {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    padding: 5px 10px;
    font-size: 1.1em;
    transition: color 0.2s;
    font-weight: 600;
}
.share-button:hover {
    color: var(--secondary-color);
}

/* ==================================== */
/* --- Pagination & Bottom Nav --- */
/* ==================================== */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px 0;
    gap: 15px;
}
.pagination button {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: 600;
}
.pagination button:hover:not(:disabled) {
    background-color: #152d61;
}
.pagination button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
.pagination span {
    font-weight: 600;
    color: #666;
}

.bottom-navigation {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: space-around;
    background-color: var(--card-bg);
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    z-index: 20;
    padding: 5px 0;
}

.bottom-navigation a {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    color: #6c757d;
    text-decoration: none;
    font-size: 0.75rem;
}

.bottom-navigation a i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 3px;
}

.bottom-navigation a:hover,
.bottom-navigation a.active {
    color: var(--primary-color);
}

    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-btn" aria-label="Go Back to Home">
                <i class="fas fa-arrow-left"></i>
            </a>
            <i class="fas fa-newspaper header-logo-icon"></i> <h1>Eksu Hub News</h1>
        </div>
    </div>

    <div class="container">
        <p class="trending-label">Trending News</p>

        <div class="slideshow-container">
            <div id="slideshow" class="slideshow">
                <div class="slide" style="justify-content: center;">
                    <p>Loading trending news...</p>
                </div>
            </div>
        </div>

        <hr class="demarcation-line" />

        <div id="articleList" class="article-list">
            <p id="loadingMessage" style="text-align: center;">Loading articles...</p>
        </div>

        <div class="pagination">
            <button id="prevPage" disabled>Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPage" disabled>Next</button>
        </div>

        <div id="noArticles" class="no-articles" style="display: none; text-align: center; padding: 30px;">
            <i class="fas fa-exclamation-circle" style="color: var(--secondary-color); font-size: 1.5rem; margin-bottom: 10px;"></i>
            <p style="color: #666;">No articles found yet.</p>
        </div>
    </div>

    <div class="bottom-navigation">
        <a href="index.html"><i class="fas fa-home"></i>Home</a>
        <a href="chat.html"><i class="fas fa-comments"></i>Chat</a>
        <a href="news.html" class="active"><i class="fas fa-newspaper"></i>News</a>
        <a href="market.html"><i class="fas fa-store"></i>Market</a>
        <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
    </div>

    <script>
      // --- Supabase Initialization ---
      const SUPABASE_URL = 'https://dyrsbfrvonajerbfrxzw.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5cnNiZnJ2b25hamVyYmZyeHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDk0ODAsImV4cCI6MjA3NTMyNTQ4MH0.mgj9f_ROkti_I3CeJ4ebYVhaLGy9Wamvj4XTtH_rB_I';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const ARTICLES_PER_PAGE = 9;
      let currentPage = 0;
      let totalArticles = 0;
      let allArticlesForSlideshow = [];

      const articleList = document.getElementById('articleList');
      const loadingMessage = document.getElementById('loadingMessage');
      const noArticlesMessage = document.getElementById('noArticles');
      const pageInfo = document.getElementById('pageInfo');
      const prevButton = document.getElementById('prevPage');
      const nextButton = document.getElementById('nextPage');
      const slideshowContainer = document.getElementById('slideshow');

      const SLIDE_COUNT = 3;
      const SLIDE_INTERVAL = 5000;
      let slideIndex = 0;

      document.addEventListener('DOMContentLoaded', () => {
          prevButton.addEventListener('click', () => changePage(-1));
          nextButton.addEventListener('click', () => changePage(1));
          fetchArticlesAndInitialize();
      });

      function changePage(delta) {
          currentPage += delta;
          loadArticles();
      }

      async function fetchArticlesAndInitialize() {
        loadingMessage.style.display = 'block';

        try {
          const { data: articles, error, count } = await supabase
            .from('articles')
            .select('id, created_at, title, content, image_url, likes', { count: 'exact' })
            .order('created_at', { ascending: false })
            .limit(100);

          if (error) throw error;

          totalArticles = count;
          allArticlesForSlideshow = articles || [];

          if (totalArticles === 0) {
            loadingMessage.style.display = 'none';
            noArticlesMessage.style.display = 'block';
            return;
          }

          // Now fetch comment counts for these articles
          await fetchCommentCountsForArticles(allArticlesForSlideshow);

          setupSlideshow();
          loadArticles();
        } catch (error) {
          console.error('Error fetching initial articles:', error);
          loadingMessage.style.display = 'none';
          articleList.innerHTML = `<p style="color: red; text-align: center;">Failed to load news: ${error.message}</p>`;
        }
      }

      /**
       * For each article in the array, fetch the comment count and attach as property article.commentCount.
       */
      async function fetchCommentCountsForArticles(articles) {
        // Using Promise.all so requests fire in parallel
        const promises = articles.map(async (article) => {
          const { count, error } = await supabase
            .from('comments')
            .select('*', { count: 'exact', head: true })
            .eq('article_id', article.id);
          if (error) {
            console.error('Error counting comments for article', article.id, error);
            article.commentCount = 0;
          } else {
            article.commentCount = count || 0;
          }
        });
        await Promise.all(promises);
      }

      async function loadArticles() {
        const from = currentPage * ARTICLES_PER_PAGE;
        const to = from + ARTICLES_PER_PAGE;
        const articles = allArticlesForSlideshow.slice(from, to);

        articleList.innerHTML = '';
        loadingMessage.style.display = 'none';
        noArticlesMessage.style.display = 'none';

        const totalPages = Math.ceil(totalArticles / ARTICLES_PER_PAGE);
        pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
        prevButton.disabled = currentPage === 0;
        nextButton.disabled = currentPage >= totalPages - 1;

        if (articles.length === 0 && totalArticles > 0) {
          articleList.innerHTML =
            '<p style="text-align: center; color: #999;">No more articles on this page.</p>';
          return;
        }

        articles.forEach(renderArticleCard);
        articleList.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function renderArticleCard(article) {
        const card = document.createElement('div');
        card.className = 'article-card';

        const articleUrl = `${window.location.href
          .split('?')[0]
          .replace('news.html', 'readmore.html')}?id=${article.id}`;

        card.onclick = (e) => {
          if (
            e.target.closest('.like-button') ||
            e.target.closest('.share-button') ||
            e.target.closest('.comment-button')
          )
            return;
          window.location.href = articleUrl;
        };

        const imageSrc = article.image_url || 'https://via.placeholder.com/400x200?text=No+Image';
        const date = new Date(article.created_at).toLocaleDateString();
        const safeTitle = article.title.replace(/'/g, "\\'");

        const isLiked =
          localStorage.getItem(`article-liked-${article.id}`) === 'true'
            ? 'liked'
            : '';
        const likeIconClass = isLiked ? 'fas' : 'far';

        // Use the fetched commentCount
        const commentCount = article.commentCount || 0;

        card.innerHTML = `
          <img src="${imageSrc}" alt="${article.title}" />
          <div class="article-content">
            <h2>${article.title}</h2>
            <p>${article.content}</p>
            <div class="meta">
              <div class="interaction-bar">
                <div class="interaction-item like-button ${isLiked}" data-id="${article.id}" onclick="toggleLike(event, ${article.id})">
                  <i class="${likeIconClass} fa-heart"></i>
                  <span class="like-count">${article.likes || 0}</span>
                </div>
                <a href="${articleUrl}" class="interaction-item comment-button" aria-label="View comments">
                  <i class="far fa-comment"></i>
                  <span class="comment-count">${commentCount}</span>
                </a>
              </div>
              <span>${date}</span>
              <button class="share-button" onclick="shareArticle('${safeTitle}', '${articleUrl}')">
                <i class="fas fa-share-alt"></i> Share
              </button>
            </div>
          </div>
        `;
        articleList.appendChild(card);
      }

      async function toggleLike(event, articleId) {
        event.stopPropagation();

        const likeButton = event.currentTarget;
        const likeCountSpan = likeButton.querySelector('.like-count');
        const likeIcon = likeButton.querySelector('i');

        if (localStorage.getItem(`article-liked-${articleId}`) === 'true') {
          return;
        }

        let currentLikes = parseInt(likeCountSpan.textContent, 10);
        const newLikes = currentLikes + 1;

        likeCountSpan.textContent = newLikes;
        likeButton.classList.add('liked');
        likeIcon.classList.remove('far');
        likeIcon.classList.add('fas');

        localStorage.setItem(`article-liked-${articleId}`, 'true');

        try {
          const { error } = await supabase
            .from('articles')
            .update({ likes: newLikes })
            .eq('id', articleId);

          if (error) {
            throw error;
          }

          console.log(`Article ${articleId} liked successfully.`);
        } catch (error) {
          console.error('Error liking article:', error.message);

          likeCountSpan.textContent = currentLikes;
          likeButton.classList.remove('liked');
          likeIcon.classList.remove('fas');
          likeIcon.classList.add('far');
          localStorage.removeItem(`article-liked-${articleId}`);
          alert('Failed to register like. Please try again.');
        }
      }
      window.toggleLike = toggleLike;

      function setupSlideshow() {
        if (allArticlesForSlideshow.length === 0) return;

        let randomArticles = [];
        let tempArray = [...allArticlesForSlideshow];
        for (let i = 0; i < SLIDE_COUNT; i++) {
          if (tempArray.length === 0) break;
          const randomIndex = Math.floor(Math.random() * tempArray.length);
          randomArticles.push(tempArray[randomIndex]);
          tempArray.splice(randomIndex, 1);
        }

        slideshowContainer.innerHTML = '';
        randomArticles.forEach((article) => {
          const articleUrl = `${window.location.href
            .split('?')[0]
            .replace('news.html', 'readmore.html')}?id=${article.id}`;
          const slide = document.createElement('a');
          slide.className = 'slide';
          slide.href = articleUrl;
          slide.style.width = '100%';

          // Use the fetched commentCount
          const commentCount = article.commentCount || 0;

          slide.innerHTML = `
            <img src="${article.image_url || 'https://via.placeholder.com/80?text=News'}" alt="${article.title}" />
            <div class="slide-content">
              <h3>${article.title}</h3>
              <p>${article.content}</p>
              <div class="slide-meta">
                <i class="far fa-comment"></i> ${commentCount} Comments
              </div>
            </div>
          `;
          slideshowContainer.appendChild(slide);
        });

        startSlideshowTimer();
      }

      function startSlideshowTimer() {
        if (slideshowContainer.children.length <= 1) return;

        if (window.slideshowTimer) clearInterval(window.slideshowTimer);

        window.slideshowTimer = setInterval(() => {
          slideIndex++;
          if (slideIndex >= slideshowContainer.children.length) {
            slideIndex = 0;
          }
          updateSlideshowPosition();
        }, SLIDE_INTERVAL);
      }

      function updateSlideshowPosition() {
        const offset = -slideIndex * 100;
        slideshowContainer.style.transform = `translateX(${offset}%)`;
      }

      function shareArticle(articleTitle, articleUrl) {
        if (navigator.share) {
          navigator
            .share({
              title: `EKSU News: ${articleTitle}`,
              url: articleUrl,
            })
            .catch((error) => console.error('Error sharing:', error));
        } else {
          alert(`Share this link:\n\n${articleTitle}\n${articleUrl}`);
          navigator.clipboard.writeText(`${articleTitle} - Read more: ${articleUrl}`);
        }
      }
      window.shareArticle = shareArticle;
    </script>
</body>
</html>
