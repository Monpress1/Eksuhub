<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EksuHub Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; text-align: center; }
        .btn { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #0f0; background: transparent; color: #0f0; font-weight: bold; }
        #status { border: 1px solid #333; padding: 10px; margin-top: 20px; min-height: 50px; text-align: left; font-size: 12px; }
    </style>
</head>
<body>

    <h3>TERMINAL DEBUG</h3>
    <button id="regBtn" class="btn">1. ATTEMPT REGISTER</button>
    <button id="testBtn" class="btn">2. ATTEMPT TEST</button>
    
    <div id="status">Initializing...</div>

    <script>
        // Use a standard function to ensure it loads correctly
        window.onload = function() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML += "<br>> Window Loaded";

            if (typeof supabase === 'undefined') {
                statusDiv.innerHTML += "<br>> ❌ ERROR: Supabase library NOT loaded. Check internet.";
                return;
            }

            const SB_URL = 'https://wfhaiasdkkmwjzrndcmi.supabase.co';
            const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaGFpYXNka2ttd2p6cm5kY21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTE5MDUsImV4cCI6MjA3OTcyNzkwNX0.jTBRJi4lpmbv4R5rxF_CS9GrF5UMVxiIH9Th9frGWWI';
            const VAPID_PUBLIC = 'BPaWbV_X2Z1OG9C6w0L6TjJxqPRUA5s4GgIKIPsvay4TuQIFMT7qkcuDIQQk2p8czR374Bh3J9Fyhx6sVmOWSsg';

            const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
            statusDiv.innerHTML += "<br>> ✅ Supabase Ready";

            // Helper
            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
                return outputArray;
            }

            document.getElementById('regBtn').onclick = async () => {
                statusDiv.innerHTML += "<br>> Clicked Register...";
                try {
                    const permission = await Notification.requestPermission();
                    statusDiv.innerHTML += "<br>> Permission: " + permission;
                    
                    if (permission !== 'granted') return;

                    const reg = await navigator.serviceWorker.register('sw.js');
                    statusDiv.innerHTML += "<br>> SW Registered";

                    const sub = await reg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC)
                    });

                    const { error } = await supabaseClient.from('push_subscriptions').upsert({ 
                        subscription_json: sub 
                    }, { onConflict: 'subscription_json' });

                    if (error) throw error;
                    statusDiv.innerHTML += "<br>> ✅ DB Updated!";
                    alert("Registration Successful");
                } catch (e) {
                    statusDiv.innerHTML += "<br>> ❌ Error: " + e.message;
                    console.error(e);
                }
            };

            document.getElementById('testBtn').onclick = async () => {
                statusDiv.innerHTML += "<br>> Clicked Test...";
                try {
                    const { data } = await supabaseClient.from('push_subscriptions').select('*').limit(1).single();
                    if (!data) throw new Error("No device found");

                    const res = await fetch(`${SB_URL}/functions/v1/push-notifications`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'apikey': SB_KEY },
                        body: JSON.stringify({ subscription: data.subscription_json })
                    });
                    
                    statusDiv.innerHTML += "<br>> Function Response: " + res.status;
                } catch (e) {
                    statusDiv.innerHTML += "<br>> ❌ Test Failed: " + e.message;
                }
            };
        };
    </script>
</body>
</html>
