<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eksu-hub Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for full screen and responsiveness */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: "Inter", sans-serif;
            background-color: #e0f2fe;
        }

        body {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .chat-container {
            background-color: #ffffff;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 0;
            box-shadow: none;
            width: 100%;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .chat-container {
                max-width: 800px;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            body {
                padding: 20px;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c;
        }
        .dark-mode .chat-container {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode .chat-header {
            background-color: #4a5568;
        }
        .dark-mode .messages-area {
            background-color: #2d3748;
        }
        .dark-mode .message-bubble.received {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        .dark-mode .message-bubble.sent {
            background-color: #fdba74;
            color: #1a202c;
        }
        .dark-mode .message-bubble.announcement {
            background-color: #cc3700;
        }
        .dark-mode .message-bubble.status-update {
            background-color: #6b7280;
            color: #cbd5e0;
        }
        .dark-mode .message-input-area {
            background-color: #2d3748;
            border-top-color: #4a5568;
        }
        .dark-mode .message-input {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }
        .dark-mode .message-input::placeholder {
            color: #a0aec0;
        }
        .dark-mode .send-button, .dark-mode .upload-button, .dark-mode .emoji-button, .dark-mode .theme-toggle-button, .dark-mode .menu-button {
            background-color: #6366f1;
        }
        .dark-mode .send-button:hover, .dark-mode .upload-button:hover, .dark-mode .emoji-button:hover, .dark-mode .theme-toggle-button:hover, .dark-mode .menu-button:hover {
            background-color: #4f46e5;
        }
        .dark-mode .send-button:active, .dark-mode .upload-button:active, .dark-mode .emoji-button:active, .dark-mode .theme-toggle-button:active, .dark-mode .menu-button:active {
            transform: scale(0.98);
        }
        .dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode .modal-content h2, .dark-mode .modal-content h3 {
            color: #e2e8f0;
        }
        .dark-mode .modal-content input,
        .dark-mode .modal-content textarea,
        .dark-mode .modal-content select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }
        .dark-mode .modal-content button {
            background-color: #6366f1;
        }
        .dark-mode .modal-content button:hover {
            background-color: #4f46e5;
        }
        .dark-mode .modal-content .close-button {
            color: #a0aec0;
        }
        .dark-mode .modal-content .close-button:hover {
            color: #e2e8f0;
        }
        .dark-mode .loading-indicator,
        .dark-mode .text-gray-500,
        .dark-mode .text-gray-600 {
            color: #a0aec0;
        }
        .dark-mode .font-semibold.text-blue-700 {
            color: #90cdf4;
        }
        .dark-mode .day-divider {
            color: #cbd5e0;
            background-color: #4a5568;
        }
        .dark-mode .sidebar {
            background-color: #2d3748;
            border-left-color: #4a5568;
        }
        .dark-mode .sidebar a {
            color: #e2e8f0;
        }
        .dark-mode .sidebar a:hover {
            background-color: #4a5568;
        }

        .chat-header {
            background: #212121;
            color: white;
            padding: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            flex-shrink: 0;
            border-bottom: 1px solid #1e40af;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .chat-header {
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }
        }

        #networkIndicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.3s ease-in-out;
        }
        .status-red {
            background-color: #ef4444; /* disconnected */
        }
        .status-green {
            background-color: #22c55e; /* connected */
        }
        .status-orange {
            background-color: #f97316; /* bad network */
        }

        .messages-area {
            flex-grow: 1;
            padding: 0.5rem 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: #eff6ff;
            scroll-behavior: smooth;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.4rem 0.8rem;
            border-radius: 18px;
            line-height: 1.3;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            transform: translateY(10px);
            opacity: 0;
            position: relative;
        }

        .message-bubble.show {
            transform: translateY(0);
            opacity: 1;
        }

        .message-bubble.sent {
            align-self: flex-end;
            background-color: #fbbf24;
            color: #1f2937;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            align-self: flex-start;
            background-color: #ffffff;
            color: #374151;
            border-bottom-left-radius: 4px;
        }

        .message-bubble.announcement {
            align-self: center;
            background-color: #ea580c;
            color: white;
            text-align: center;
            font-weight: bold;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            max-width: 90%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .message-bubble.status-update {
            align-self: center;
            background-color: #bfdbfe;
            color: #1e40af;
            text-align: center;
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        }

        .day-divider {
            align-self: center;
            margin: 15px 0;
            padding: 5px 15px;
            background-color: #93c5fd;
            color: #1e40af;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-input-area {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: #ffffff;
            gap: 8px;
            align-items: flex-end;
            flex-shrink: 0;
        }

        .message-input {
            flex-grow: 1;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            resize: none;
            overflow-y: hidden;
            min-height: 38px;
            line-height: 1.4;
            max-height: 120px;
        }

        .send-button, .upload-button, .emoji-button, .theme-toggle-button, .menu-button {
            background-color: #2563eb;
            color: white;
            padding: 0.6rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            height: 38px;
            width: 38px;
        }

        .send-button:hover, .upload-button:hover, .emoji-button:hover, .theme-toggle-button:hover, .menu-button:hover {
            background-color: #1e40af;
            transform: translateY(-1px);
        }

        .send-button:active, .upload-button:active, .emoji-button:active, .theme-toggle-button:active, .menu-button:active {
            transform: scale(0.98);
        }

        .upload-button input[type="file"] {
            display: none;
        }

        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
        }

        .emoji-picker-modal {
            position: absolute;
            bottom: 70px;
            left: 10px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }

        .dark-mode .emoji-picker-modal {
            background-color: #4a5568;
        }

        .emoji-picker-modal button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.1s;
        }

        .emoji-picker-modal button:hover {
            background-color: #e2e8f0;
        }

        .dark-mode .emoji-picker-modal button:hover {
            background-color: #6b7280;
        }

        .new-messages-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background-color: #2563eb;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 90;
            display: none;
            transition: opacity 0.3s ease-in-out;
        }

        .dark-mode .new-messages-indicator {
            background-color: #6366f1;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .modal-content h2, .modal-content h3 {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 10px;
        }

        .modal-content input,
        .modal-content textarea,
        .modal-content select {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .modal-content button {
            background-color: #2563eb;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.2s;
            border: none;
        }

        .modal-content button:hover {
            background-color: #1e40af;
        }

        .modal-content .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: #6b7280;
        }

        .modal-content .close-button:hover {
            color: #1f2937;
        }

        .hidden {
            display: none;
        }

        .loading-indicator {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 10px;
        }

        /* --- ANIMATION STYLES --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .shake-active {
            animation: shake 0.2s ease-in-out infinite;
        }

        @keyframes glitter-fade-in {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .glitter-star {
            position: fixed;
            font-size: 24px;
            color: gold;
            text-shadow: 0 0 5px orange;
            pointer-events: none;
            z-index: 999;
            animation: glitter-fade-in 1.5s ease-out forwards;
        }

        @keyframes rise-and-fade {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-100vh) scale(1.2); opacity: 0; }
        }

        .love-emoji {
            position: fixed;
            bottom: -50px;
            font-size: 30px;
            pointer-events: none;
            z-index: 999;
            animation: rise-and-fade 4s ease-out forwards;
            opacity: 0;
        }

        @keyframes confetti-fall {
            0% { opacity: 0; transform: translate(0, -20px) rotate(0deg); }
            10% { opacity: 1; }
            100% { opacity: 0; transform: translate(var(--x), var(--y)) rotate(var(--deg)); }
        }

        .confetti {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            animation: confetti-fall var(--duration) ease-out forwards;
        }

        @keyframes droplet-fall {
            0% { opacity: 0; transform: translateY(-10px) scale(0.8); }
            20% { opacity: 1; }
            100% { opacity: 0; transform: translateY(100vh) scale(1.2); }
        }

        .droplet {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            animation: droplet-fall var(--duration) ease-in forwards;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -250px;
            width: 250px;
            height: 100%;
            background-color: #ffffff;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
            transition: right 0.3s ease-in-out;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: flex-end;
            padding: 1rem;
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .sidebar-close-button {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #4a5568;
            padding: 0.5rem;
            transition: color 0.2s;
        }

        .sidebar-close-button:hover {
            color: #1a202c;
        }

        .dark-mode .sidebar-close-button {
            color: #a0aec0;
        }

        .dark-mode .sidebar-close-button:hover {
            color: #e2e8f0;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar-nav a {
            display: block;
            padding: 0.75rem 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-nav a:hover {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .sending-image {
            opacity: 0.5;
        }

        .typing-indicator {
            font-style: italic;
            color: #888;
            text-align: center;
            padding: 5px 0;
        }
        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .message-status {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
            gap: 4px;
        }
        .message-bubble.received .message-status {
            justify-content: flex-start;
        }
        .read-receipt {
            font-size: 0.8rem;
        }
        .read-receipt.sent-tick {
            color: #9ca3af;
        }
        .read-receipt.read-ticks {
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-blue-100">

    <div class="chat-container">
        <div class="chat-header flex justify-between items-center">
            <div id="networkIndicator" class="w-3 h-3 rounded-full status-red"></div>
            <span class="flex-grow text-center">Eksu Chat</span>
            <button id="themeToggleButton" class="theme-toggle-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM7.5 12a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.894 6.166a.75.75 0 0 0-1.06-1.06l-1.591 1.59a.75.75 0 1 0 1.06 1.061l1.591-1.59ZM12 18a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V18a.75.75 0 0 1 .75-.75ZM5.929 17.395a.75.75 0 0 0-1.06 1.06l1.59 1.591a.75.75 0 0 0 1.061-1.06l-1.591-1.59ZM18 12a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H18a.75.75 0 0 1-.75-.75ZM6 12a.75.75 0 0 1-.75.75H3a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM17.395 18.894a.75.75 0 0 0 1.06-1.06l-1.591-1.59a.75.75 0 0 0-1.06 1.061l1.591 1.59ZM6.166 5.929a.75.75 0 0 0-1.06-1.06l-1.59 1.591a.75.75 0 1 0 1.06 1.061l1.591-1.59Z" />
                </svg>
            </button>
            <button id="menuButton" class="menu-button ml-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
        <div id="chatMessages" class="messages-area">
            <div id="loadingMessages" class="loading-indicator">Messages are loading...</div>
        </div>

        <div class="typing-indicator" id="typingIndicator"></div>

        <div class="message-input-area relative">
            <button id="emojiButton" class="emoji-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 16.25a.75.75 0 0 0-1.5 0h1.5ZM10.5 8.25a.75.75 0 0 0-1.5 0v1.5a.75.75 0 0 0 1.5 0V8.25ZM15 8.25a.75.75 0 0 0-1.5 0v1.5a.75.75 0 0 0 1.5 0V8.25Z" clip-rule="evenodd" />
                </svg>
            </button>
            <textarea id="messageInput" class="message-input" placeholder="Type your message..." rows="1"></textarea>
            <label for="imageUpload" class="upload-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M12 5.25a.75.75 0 0 1 .75.75v5.25H18a.75.75 0 0 1 0 1.5h-5.25V18a.75.75 0 0 1-1.5 0v-5.25H6a.75.75 0 0 1 0-1.5h5.25V6a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <input type="file" id="imageUpload" accept="image/*">
            </label>
            <button id="sendButton" class="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
            <div id="emojiPicker" class="emoji-picker-modal hidden"></div>
        </div>
    </div>

    <div id="newMessagesIndicator" class="new-messages-indicator hidden">
        New Messages ðŸ‘‡
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay hidden"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <button id="sidebarCloseButton" class="sidebar-close-button">&times;</button>
        </div>
        <nav class="sidebar-nav">
            <a href="index.html" class="sidebar-item">Dashboard</a>
            <a href="market.html" class="sidebar-item">Market</a>
            <a href="news.html" class="sidebar-item">News</a>
            <a href="quicktest.html" class="sidebar-item">Quick Test</a>
        </nav>
    </div>

    <div id="userProfileDisplayModal" class="modal-overlay hidden">
        <div class="modal-content profile-modal-content relative">
            <button class="close-button" id="closeUserProfileModal">&times;</button>
            <h3 id="displayNickname"></h3>
            <p><span class="font-semibold">Interest:</span> <span id="displayInterest"></span></p>
            <p><span class="font-semibold">Gender:</span> <span id="displayGender"></span></p>
            <p><span class="font-semibold">Status:</span> <span id="displayStatus" class="font-bold"></span></p>
        </div>
    </div>

    <div id="signupModal" class="modal-overlay hidden">
        <div class="modal-content signup-modal-content">
            <h2>Welcome!</h2>
            <p class="text-center text-gray-600">Please tell us about yourself to join the chat.</p>
            <input type="text" id="signupNickname" placeholder="Nickname" required>
            <input type="text" id="signupInterest" placeholder="Your Interest (e.g., coding, art, gaming)">
            <select id="signupGender" class="p-2 border rounded" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Non-binary">Non-binary</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>
            <button id="signupButton">Join Chat</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    let ws;
    let persistentUserId = localStorage.getItem('chatPersistentUserId');
    let userProfile = JSON.parse(localStorage.getItem('chatUserProfile')) || null;
    let allDisplayedMessages = [];
    let onlineUsers = new Map();
    let db;
    let isTyping = false;
    let typingTimeout;
    let readObserver;
    let lastMessageDate = '';

    const WEBSOCKET_SERVER_URL = 'wss://websocket-server-6jct.onrender.com'; // Change to your server URL
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const newMessagesIndicator = document.getElementById('newMessagesIndicator');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const themeToggleButton = document.getElementById('themeToggleButton');
    const menuButton = document.getElementById('menuButton');
    const sidebarCloseButton = document.getElementById('sidebarCloseButton');
    const signupModal = document.getElementById('signupModal');
    const signupButton = document.getElementById('signupButton');
    const signupNickname = document.getElementById('signupNickname');
    const signupInterest = document.getElementById('signupInterest');
    const signupGender = document.getElementById('signupGender');
    const networkIndicator = document.getElementById('networkIndicator');
    const userProfileDisplayModal = document.getElementById('userProfileDisplayModal');
    const closeUserProfileModal = document.getElementById('closeUserProfileModal');
    const imageUpload = document.getElementById('imageUpload');
    const emojiButton = document.getElementById('emojiButton');
    const emojiPicker = document.getElementById('emojiPicker');

    // --- WORD-TRIGGERED ANIMATIONS ---
    const animationTriggers = [
        { word: 'death', type: 'shake', duration: 2000, color: 'text-red-500' },
        { word: 'movie', type: 'glitter', count: 15, duration: 4000 },
        { word: 'love', type: 'love_emojis', count: 20, duration: 4000 },
        { word: 'happy', type: 'confetti', count: 50, duration: 3000 },
        { word: 'monpress', type: 'confetti', count: 50, duration: 3000 },
        { word: 'sad', type: 'droplet', count: 30, duration: 3000 },
        { word: 'peace', type: 'glitter', count: 15, duration: 4000 },
        { word: 'fuck', type: 'shake', duration: 2000 }
    ];

    function checkAndTriggerAnimations(messageText) {
        const lowerCaseText = messageText.toLowerCase();
        animationTriggers.forEach(trigger => {
            if (lowerCaseText.includes(trigger.word)) {
                switch (trigger.type) {
                    case 'shake':
                        triggerShakeAnimation(trigger.duration);
                        break;
                    case 'glitter':
                        triggerGlitterAnimation(trigger.count, trigger.duration);
                        break;
                    case 'love_emojis':
                        triggerLoveAnimation(trigger.count, trigger.duration);
                        break;
                    case 'confetti':
                        triggerConfettiAnimation(trigger.count, trigger.duration);
                        break;
                    case 'droplet':
                        triggerDropletAnimation(trigger.count, trigger.duration);
                        break;
                }
            }
        });
    }

    function triggerShakeAnimation(duration) {
        const body = document.body;
        body.classList.add('shake-active');
        setTimeout(() => {
            body.classList.remove('shake-active');
        }, duration);
    }

    function triggerGlitterAnimation(count, duration) {
        const area = document.body;
        for (let i = 0; i < count; i++) {
            const star = document.createElement('span');
            star.textContent = 'â­';
            star.classList.add('glitter-star');
            star.style.left = `${Math.random() * 100}vw`;
            star.style.top = `${Math.random() * 100}vh`;
            star.style.animationDuration = `${duration / 1000}s`;
            area.appendChild(star);
            star.addEventListener('animationend', () => star.remove());
        }
    }

    function triggerLoveAnimation(count, duration) {
        const area = document.body;
        for (let i = 0; i < count; i++) {
            const heart = document.createElement('span');
            heart.textContent = 'â¤ï¸';
            heart.classList.add('love-emoji');
            heart.style.left = `${Math.random() * 100}vw`;
            heart.style.animationDuration = `${duration / 1000}s`;
            heart.style.animationDelay = `${Math.random() * 0.5}s`;
            area.appendChild(heart);
            heart.addEventListener('animationend', () => heart.remove());
        }
    }

    function triggerConfettiAnimation(count, duration) {
        const colors = ['#f06292', '#81c784', '#64b5f6', '#ffd54f', '#ba68c8', '#ff9800', '#cddc39'];
        const area = document.body;
        for (let i = 0; i < count; i++) {
            const confetti = document.createElement('div');
            const size = Math.random() * 8 + 4;
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size * 1.5}px`;
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.position = 'fixed';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.top = `-20px`;
            confetti.style.opacity = '0';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            confetti.style.zIndex = '9999';
            area.appendChild(confetti);
            const finalX = (Math.random() * 200) - 100;
            const finalY = window.innerHeight + (Math.random() * 100) + 50;
            const finalDeg = Math.random() * 720 + 360;
            confetti.style.setProperty('--x', `${finalX}px`);
            confetti.style.setProperty('--y', `${finalY}px`);
            confetti.style.setProperty('--deg', `${finalDeg}deg`);
            confetti.style.setProperty('--duration', `${duration / 1000}s`);
            setTimeout(() => {
                confetti.classList.add('confetti');
            }, 10);
            confetti.addEventListener('animationend', () => confetti.remove());
        }
    }

    function triggerDropletAnimation(count, duration) {
        const colors = ['#90caf9', '#64b5f6', '#42a5f5', '#2196f3', '#1976d2'];
        const area = document.body;
        for (let i = 0; i < count; i++) {
            const droplet = document.createElement('div');
            droplet.style.width = '5px';
            droplet.style.height = '10px';
            droplet.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            droplet.style.borderRadius = '50% 50% 50% 0';
            droplet.style.position = 'fixed';
            droplet.style.left = `${Math.random() * 100}vw`;
            droplet.style.bottom = `-10px`;
            droplet.style.opacity = '0';
            droplet.style.zIndex = '9999';
            area.appendChild(droplet);
            droplet.style.setProperty('--duration', `${duration / 1000}s`);
            setTimeout(() => {
                droplet.classList.add('droplet');
            }, 10);
            droplet.addEventListener('animationend', () => droplet.remove());
        }
    }

    // --- Event Listeners for new UI elements ---
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessageFromInput();
        } else {
            sendTypingStatus();
        }
    });
    document.getElementById('sendButton').addEventListener('click', sendMessageFromInput);
    menuButton.addEventListener('click', () => {
        sidebar.classList.add('open');
        sidebarOverlay.classList.remove('hidden');
    });
    sidebarCloseButton.addEventListener('click', () => {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.add('hidden');
    });
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.add('hidden');
    });
    themeToggleButton.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
    });
    signupButton.addEventListener('click', () => {
        const nickname = signupNickname.value.trim();
        const interest = signupInterest.value.trim();
        const gender = signupGender.value;
        if (nickname) {
            userProfile = { nickname, interest, gender };
            localStorage.setItem('chatUserProfile', JSON.stringify(userProfile));
            signupModal.classList.add('hidden');
            startApp();
        } else {
            alert("Please enter a nickname to continue.");
        }
    });
    chatMessages.addEventListener('scroll', () => {
        if (isScrolledToBottom()) {
            newMessagesIndicator.classList.add('hidden');
        }
    });
    newMessagesIndicator.addEventListener('click', () => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
        newMessagesIndicator.classList.add('hidden');
    });
    closeUserProfileModal.addEventListener('click', () => {
        userProfileDisplayModal.classList.add('hidden');
    });

    // --- IndexedDB Functions ---
    function initDb() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('chatDb', 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('messages')) {
                    db.createObjectStore('messages', { keyPath: 'id' });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve();
            };
            request.onerror = (event) => {
                console.error('IndexedDB error:', event.target.errorCode);
                reject(event.target.error);
            };
        });
    }

    function getMessagesFromDb() {
        return new Promise((resolve) => {
            if (!db) return resolve([]);
            const transaction = db.transaction(['messages'], 'readonly');
            const store = transaction.objectStore('messages');
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => resolve([]);
        });
    }

    function addMessageToDb(message) {
        if (!db) return;
        const transaction = db.transaction(['messages'], 'readwrite');
        const store = transaction.objectStore('messages');
        store.put(message);
    }

    function syncHistoryWithDb(serverMessages) {
        return new Promise(async (resolve) => {
            const localMessages = await getMessagesFromDb();
            const localMessageIds = new Set(localMessages.map(msg => msg.id));
            const newMessages = [];
            serverMessages.forEach(msg => {
                // Check if message is a new chat message
                const isNewChatMessage = msg.type === "message" && !localMessageIds.has(msg.id);
                // Check if it's a new broadcast
                const isNewBroadcast = msg.type === "broadcast" && !localMessageIds.has(msg.id);
                
                if (isNewChatMessage || isNewBroadcast) {
                    newMessages.push(msg);
                    addMessageToDb(msg);
                }
            });
            resolve(newMessages);
        });
    }

    function startApp() {
        initDb().then(() => {
            connect();
        }).catch(err => {
            console.error("Failed to initialize IndexedDB:", err);
            connect();
        });
    }

    function connect() {
        ws = new WebSocket(WEBSOCKET_SERVER_URL);
        setupReadReceiptObserver();
        const loadingMessagesDiv = document.getElementById('loadingMessages');
        if (loadingMessagesDiv) {
            loadingMessagesDiv.textContent = "Connecting...";
        }
        setNetworkStatus('red');
        ws.onopen = () => {
            console.log("Connected to server âœ…");
            setNetworkStatus('green');
            const loadingMessagesDiv = document.getElementById('loadingMessages');
            if (loadingMessagesDiv) {
                loadingMessagesDiv.textContent = "Fetching messages...";
            }
            if (!persistentUserId) {
                persistentUserId = crypto.randomUUID();
                localStorage.setItem('chatPersistentUserId', persistentUserId);
                if (!userProfile) {
                    userProfile = { nickname: '', gender: '', interest: '' };
                }
                localStorage.setItem('chatUserProfile', JSON.stringify(userProfile));
            }
            const nicknameToSend = userProfile?.nickname || 'Guest';
            ws.send(JSON.stringify({
                type: "init",
                userId: persistentUserId,
                username: nicknameToSend,
                gender: userProfile?.gender || 'N/A',
                interests: userProfile?.interest || 'N/A',
                bio: userProfile?.bio || ''
            }));
        };

        ws.onmessage = async (event) => {
            let raw;
            try {
                raw = JSON.parse(event.data);
            } catch (e) {
                console.error("Invalid WS message:", event.data);
                return;
            }

            // Centralized message handling based on type
            switch (raw.type) {
                case "init":
                    console.log("Received initial history.");
                    // Clear and re-render the whole chat
                    chatMessages.innerHTML = '';
                    const loadingMessagesDiv = document.getElementById('loadingMessages');
                    if (loadingMessagesDiv) {
                        loadingMessagesDiv.style.display = 'none';
                    }
                    allDisplayedMessages = [];
                    onlineUsers.clear();
                    
                    raw.history.forEach(msg => {
                        const message = {
                            id: msg.id,
                            senderPersistentId: msg.userId,
                            senderProfile: { nickname: msg.username, gender: msg.gender, interest: msg.interests, bio: msg.bio },
                            text: msg.content,
                            image: msg.image,
                            timestamp: msg.timestamp,
                            readBy: msg.readBy || [],
                            messageType: msg.content ? "chatMessage" : "broadcast" // Heuristic for message vs broadcast
                        };
                        addMessageToDb(message);
                        allDisplayedMessages.push(message);
                        
                        // Update online users map
                        onlineUsers.set(msg.userId, {
                            id: msg.userId,
                            name: msg.username,
                            gender: msg.gender,
                            interests: msg.interests,
                            bio: msg.bio
                        });
                    });

                    raw.onlineUsers.forEach(user => {
                        onlineUsers.set(user.id, user);
                    });

                    renderAllMessages();
                    break;
                case "message":
                    const wasScrolledToBottom = isScrolledToBottom();
                    const existingMessageIndex = allDisplayedMessages.findIndex(m => m.tempId === raw.tempId);
                    if (existingMessageIndex !== -1) {
                        const existingDiv = document.querySelector(`[data-temp-id="${raw.tempId}"]`);
                        if (existingDiv) {
                            existingDiv.remove();
                        }
                        allDisplayedMessages.splice(existingMessageIndex, 1);
                    }
                    const normalized = {
                        id: raw.id,
                        senderPersistentId: raw.userId,
                        senderProfile: {
                            nickname: raw.username,
                            gender: raw.gender,
                            interest: raw.interests,
                            bio: raw.bio
                        },
                        text: raw.content,
                        image: raw.image,
                        timestamp: raw.timestamp,
                        readBy: raw.readBy || [],
                        messageType: "chatMessage"
                    };
                    addMessageToDb(normalized);
                    allDisplayedMessages.push(normalized);
                    addMessageToUI(normalized, wasScrolledToBottom);
                    if (!wasScrolledToBottom) {
                        newMessagesIndicator.classList.remove('hidden');
                    }
                    if (normalized.text) {
                        checkAndTriggerAnimations(normalized.text);
                    }
                    break;
                case "typing":
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) typingIndicator.textContent = `${raw.username} is typing...`;
                    break;
                case "stopTyping":
                    const typingIndicator2 = document.getElementById('typingIndicator');
                    if (typingIndicator2) typingIndicator2.textContent = '';
                    break;
                case "messageRead":
                    const message = allDisplayedMessages.find(m => m.id === raw.messageId);
                    if (message && !message.readBy.includes(raw.readerId)) {
                        message.readBy.push(raw.readerId);
                        updateReadReceipts();
                    }
                    break;
                case "userStatus":
                    const userStatusMessage = {
                        id: raw.id + Date.now(), // Unique ID for status message
                        senderPersistentId: raw.id,
                        senderProfile: { nickname: raw.name },
                        text: raw.name + (raw.type === "userJoined" ? " joined the chat." : " left the chat."),
                        timestamp: Date.now(),
                        messageType: "userStatus"
                    };
                    allDisplayedMessages.push(userStatusMessage);
                    addMessageToUI(userStatusMessage, true);
                    if (raw.type === "userJoined") {
                        onlineUsers.set(raw.id, { id: raw.id, name: raw.name });
                    } else if (raw.type === "userLeft") {
                        onlineUsers.delete(raw.id);
                    }
                    break;
                case "broadcast":
                    const broadcastMsg = {
                        id: raw.id,
                        senderPersistentId: "admin",
                        senderProfile: { nickname: "Admin" },
                        text: raw.content,
                        image: null,
                        timestamp: raw.timestamp,
                        messageType: "adminBroadcast"
                    };
                    allDisplayedMessages.push(broadcastMsg);
                    addMessageToUI(broadcastMsg, true);
                    break;
                case "onlineUsers":
                    onlineUsers.clear();
                    raw.users.forEach(u => onlineUsers.set(u.id, u));
                    break;
            }
        };

        ws.onclose = (event) => {
            console.log("Disconnected âŒ, retrying in 3s...");
            setNetworkStatus('red');
            setTimeout(connect, 3000);
        };

        ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            setNetworkStatus('orange');
        };
    }

    function setNetworkStatus(status) {
        networkIndicator.classList.remove('status-red', 'status-green', 'status-orange');
        networkIndicator.classList.add(`status-${status}`);
    }

    function renderAllMessages() {
        allDisplayedMessages.sort((a, b) => a.timestamp - b.timestamp);
        chatMessages.innerHTML = '';
        lastMessageDate = '';
        allDisplayedMessages.forEach(msg => addMessageToUI(msg, false));
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessageFromInput() {
        const messageText = messageInput.value.trim();
        if (!messageText) return; // Do not send empty messages

        // Added robust check for user profile
        if (!userProfile || !userProfile.nickname) {
            alert("Please enter a nickname to join the chat.");
            signupModal.classList.remove('hidden');
            return;
        }
        
        const tempId = Date.now().toString() + Math.random().toString().substring(2, 8);
        const msg = {
            type: "message",
            userId: persistentUserId,
            username: userProfile.nickname,
            content: messageText,
            image: null,
            timestamp: Date.now(),
            tempId: tempId
        };
        
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.log("WebSocket not ready. Message not sent.");
            return;
        }

        const tempMessageForUI = { ...msg, readBy: [] };
        allDisplayedMessages.push(tempMessageForUI);
        addMessageToUI(tempMessageForUI, true);
        ws.send(JSON.stringify(msg));
        messageInput.value = '';
        sendStopTyping();
        checkAndTriggerAnimations(messageText);
    }

    function sendTypingStatus() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        if (!userProfile || !userProfile.nickname) return;
        if (!isTyping) {
            isTyping = true;
            ws.send(JSON.stringify({ type: "typing", userId: persistentUserId, username: userProfile.nickname }));
        }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(sendStopTyping, 3000);
    }

    function sendStopTyping() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        isTyping = false;
        ws.send(JSON.stringify({ type: "stopTyping", userId: persistentUserId }));
    }

    function resizeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.5) {
        return new Promise(resolve => {
            const img = new Image();
            const reader = new FileReader();
            reader.onload = e => {
                img.src = e.target.result;
            };
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let { width, height } = img;
                if (width > maxWidth || height > maxHeight) {
                    const scale = Math.min(maxWidth / width, maxHeight / height);
                    width *= scale;
                    height *= scale;
                }
                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', quality));
            };
            reader.readAsDataURL(file);
        });
    }

    imageUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // Added robust check for user profile
        if (!userProfile || !userProfile.nickname) {
            alert("Please enter a nickname to join the chat.");
            signupModal.classList.remove('hidden');
            return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.error("WebSocket not ready. Image not sent.");
            return;
        }

        resizeImage(file).then(base64 => {
            const tempId = Date.now().toString() + Math.random().toString().substring(2, 8);
            const msg = {
                type: "message",
                userId: persistentUserId,
                username: userProfile.nickname,
                content: '',
                image: base64,
                timestamp: Date.now(),
                tempId: tempId
            };
            const tempMessageForUI = { ...msg, readBy: [] };
            allDisplayedMessages.push(tempMessageForUI);
            addMessageToUI(tempMessageForUI, true);
            ws.send(JSON.stringify(msg));
        }).catch(err => {
            console.error("Image processing failed:", err);
        });
    });

    function addMessageToUI(msg, scroll = false) {
        const messageDate = new Date(msg.timestamp).toLocaleDateString();
        if (messageDate !== lastMessageDate) {
            const dateDiv = document.createElement('div');
            dateDiv.className = 'day-divider';
            dateDiv.textContent = messageDate;
            chatMessages.appendChild(dateDiv);
            lastMessageDate = messageDate;
        }

        let divClass = '';
        let nicknameText = '';

        if (msg.messageType === "chatMessage") {
            divClass = (msg.senderPersistentId === persistentUserId ? "sent" : "received");
            nicknameText = `${msg.senderProfile.nickname}: `;
        } else if (msg.messageType === "adminBroadcast") {
            divClass = 'announcement';
            nicknameText = '';
        } else if (msg.messageType === "userStatus") {
            divClass = 'status-update';
            nicknameText = '';
        }

        const div = document.createElement("div");
        div.className = `message-bubble ${divClass}`;
        div.setAttribute('data-message-id', msg.id);
        div.setAttribute('data-sender-id', msg.senderPersistentId);
        if (msg.tempId) {
            div.setAttribute('data-temp-id', msg.tempId);
        }

        if (msg.messageType === "chatMessage") {
            div.addEventListener('click', () => {
                const user = onlineUsers.get(msg.senderPersistentId) || {
                    name: msg.senderProfile.nickname,
                    interests: msg.senderProfile.interest || "N/A",
                    gender: msg.senderProfile.gender || "N/A",
                    bio: msg.senderProfile.bio || "N/A",
                    online: onlineUsers.has(msg.senderPersistentId)
                };
                displayUserProfile(user);
            });
        }
        
        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        if (nicknameText) {
            const nicknameSpan = document.createElement("strong");
            nicknameSpan.textContent = nicknameText;
            contentDiv.appendChild(nicknameSpan);
        }
        
        if (msg.text) {
            const textSpan = document.createElement("span");
            textSpan.textContent = msg.text;
            contentDiv.appendChild(textSpan);
        }
        
        if (msg.image) {
            const img = document.createElement('img');
            img.src = msg.image;
            img.alt = 'Image';
            img.className = 'chat-image';
            contentDiv.appendChild(img);
        }

        if (msg.messageType === "chatMessage") {
            const statusContainer = document.createElement("div");
            statusContainer.className = "message-status";
            const timestampSpan = document.createElement("span");
            timestampSpan.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            statusContainer.appendChild(timestampSpan);
            if (msg.senderPersistentId === persistentUserId) {
                const readReceiptSpan = document.createElement("span");
                readReceiptSpan.className = "read-receipt";
                if (msg.readBy && msg.readBy.length > 0) {
                    readReceiptSpan.textContent = "âœ“âœ“";
                    readReceiptSpan.classList.add('read-ticks');
                } else {
                    readReceiptSpan.textContent = "âœ“";
                    readReceiptSpan.classList.add('sent-tick');
                }
                statusContainer.appendChild(readReceiptSpan);
            }
            div.appendChild(contentDiv);
            div.appendChild(statusContainer);
        } else {
            div.appendChild(contentDiv);
        }
        
        chatMessages.appendChild(div);
        setTimeout(() => {
            div.classList.add('show');
        }, 10);
        if (scroll) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        if (readObserver) {
            readObserver.observe(div);
        }
    }

    function updateReadReceipts() {
        allDisplayedMessages.forEach(msg => {
            if (msg.senderPersistentId === persistentUserId) {
                const messageElement = document.querySelector(`[data-message-id="${msg.id}"]`);
                if (messageElement) {
                    const readReceiptSpan = messageElement.querySelector('.read-receipt');
                    if (readReceiptSpan) {
                        if (msg.readBy && msg.readBy.length > 0) {
                            readReceiptSpan.textContent = "âœ“âœ“";
                            readReceiptSpan.classList.remove('sent-tick');
                            readReceiptSpan.classList.add('read-ticks');
                        } else {
                            readReceiptSpan.textContent = "âœ“";
                            readReceiptSpan.classList.remove('read-ticks');
                            readReceiptSpan.classList.add('sent-tick');
                        }
                    }
                }
            }
        });
    }

    function setupReadReceiptObserver() {
        const observerOptions = {
            root: document.getElementById('chatMessages'),
            threshold: 1.0,
        };
        readObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const messageId = entry.target.getAttribute('data-message-id');
                    const message = allDisplayedMessages.find(m => m.id == messageId);
                    if (message && message.senderPersistentId !== persistentUserId && (!message.readBy || !message.readBy.includes(persistentUserId))) {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({ type: "messageRead", messageId: message.id }));
                        }
                    }
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);
    }

    function displayUserProfile(user) {
        const modal = userProfileDisplayModal;
        if (!modal) return;
        const nicknameEl = document.getElementById('displayNickname');
        const interestEl = document.getElementById('displayInterest');
        const genderEl = document.getElementById('displayGender');
        const statusEl = document.getElementById('displayStatus');
        
        if (nicknameEl) nicknameEl.textContent = user.name || 'Unknown';
        if (interestEl) interestEl.textContent = user.interests || 'N/A';
        if (genderEl) genderEl.textContent = user.gender || 'N/A';
        
        if (statusEl) {
            if (user.online) {
                statusEl.textContent = 'Online';
                statusEl.style.color = '#22c5e';
            } else {
                statusEl.textContent = 'Offline';
                statusEl.style.color = '#ef4444';
            }
        }
        modal.classList.remove('hidden');
    }

    function isScrolledToBottom() {
        const scrollThreshold = 100;
        return chatMessages.scrollHeight - chatMessages.clientHeight <= chatMessages.scrollTop + scrollThreshold;
    }

    // --- EMOJI PICKER LOGIC ---
    const emojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤‘', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ¥´', 'ðŸ˜µ', 'ðŸ¤¯', 'ðŸ¤ ', 'ðŸ¥³', 'ðŸ˜Ž', 'ðŸ¤“', 'ðŸ§', 'ðŸ˜•', 'ðŸ˜Ÿ', 'ðŸ™', 'ðŸ˜®', 'ðŸ˜¯', 'ðŸ˜²', 'ðŸ˜³', 'ðŸ¥º', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜±', 'ðŸ˜–', 'ðŸ˜£', 'ðŸ˜©', 'ðŸ˜«', 'ðŸ˜¤', 'ðŸ˜¡', 'ðŸ˜ ', 'ðŸ¤¬', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ’€', 'ðŸ’©', 'ðŸ¤¡', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾'];
    emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.textContent = emoji;
        button.addEventListener('click', () => {
            messageInput.value += emoji;
            emojiPicker.classList.add('hidden');
            messageInput.focus();
            messageInput.style.height = 'auto';
            messageInput.style.height = messageInput.scrollHeight + 'px';
        });
        emojiPicker.appendChild(button);
    });
    emojiButton.addEventListener('click', (event) => {
        event.stopPropagation();
        emojiPicker.classList.toggle('hidden');
    });
    document.addEventListener('click', (event) => {
        if (!emojiPicker.contains(event.target) && !emojiButton.contains(event.target)) {
            emojiPicker.classList.add('hidden');
        }
    });

    // --- END EMOJI PICKER LOGIC ---
    if (userProfile && userProfile.nickname && persistentUserId) {
        startApp();
    } else {
        signupModal.classList.remove('hidden');
    }
});
    </script>
</body>
</html>
