<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eksu AI | Smart Learning</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #0088ff; 
            --bg: #0f111a; 
            --card-bg: #161b22; 
            --text: #f0f0f0; 
            --border: #30363d;
            --green: #238636;
            --red: #da3633;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- Layout --- */
        .app-container { display: flex; flex-direction: column; height: 100%; max-width: 800px; margin: 0 auto; width: 100%; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        
        header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(10px); }
        
        .logo h1 { font-size: 1.3em; margin: 0; font-weight: 800; color: white; }
        .logo small { font-size: 0.7em; color: var(--primary); text-transform: uppercase; }

        .chat-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; 
        
        }

        .bubble { max-width: 85%; padding: 14px 18px; border-radius: 18px; font-size: 0.95em; line-height: 1.5; }
        .ai { background: var(--card-bg); align-self: flex-start; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .user { background: var(--primary); align-self: flex-end; color: white; border-bottom-right-radius: 4px; }

        .input-box { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg); }
        .input-box input { flex-grow: 1; background: #0d1117; border: 1px solid var(--border); color: white; padding: 14px; border-radius: 12px; outline: none; margin-bottom:30px;
        
        }
        
        .cbt-btn { background: var(--green); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom:30px;
        }
        .send-btn { background: var(--primary); color: white; border: none; width: 50px; border-radius: 12px; cursor: pointer; margin-bottom:30px; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--card-bg); width: 90%; max-width: 500px; padding: 25px; border-radius: 16px; border: 1px solid #333; max-height: 80vh; overflow-y: auto; }
        
        .option-btn { background: #21262d; color: var(--text); padding: 15px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; text-align: left; margin-bottom: 8px; width: 100%; }
        .option-btn:hover { border-color: var(--primary); background: #2c333e; }

        .progress-bar { height: 6px; background: #333; width: 100%; margin: 15px 0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); }
        
        /* Loading Spinner */
        .spinner { border: 4px solid rgba(255,255,255,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary); animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <div class="logo"><h1>Eksu AI</h1><small>Smart Assistant</small></div>
            <button class="cbt-btn" onclick="openCBTSetup()">START TEST</button>
        </header>

        <div class="chat-area" id="chatArea">
            <div class="bubble ai">Welcome! Ask me any academic question or start a CBT test.</div>
        </div>

        <div class="input-box">
            <input type="text" id="userInput" placeholder="Ask Eksu AI..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="modal-overlay" id="cbtModal">
        <div class="modal-content">
            
            <div id="setupView">
                <h2 style="text-align:center;">Course Selection</h2>
                <p style="text-align:center; color:#888;">Enter the Course Code or Topic</p>
                <input type="text" id="courseTopic" style="width:100%; padding:15px; background:#0d1117; border:1px solid #333; color:white; border-radius:8px; margin:15px 0; box-sizing: border-box;" placeholder="BIO 101">
                <button class="cbt-btn" style="width:100%; padding:15px;" onclick="beginQuiz()">START 20-QUESTION TEST</button>
                <button class="cbt-btn" style="width:100%; padding:15px; margin-top:10px; background:#333;" onclick="closeCBT()">CANCEL</button>
            </div>

            <div id="loadingView" style="display:none; text-align:center;">
                <h3>Generating Test...</h3>
                <div class="spinner"></div>
                <p style="color:#888; font-size:0.9em;">Creating 20 unique questions for <span id="loadingTopic" style="color:white;"></span>...</p>
                <p style="color:#666; font-size:0.8em;">Getting your questions  Ready</p>
            </div>

            <div id="quizView" style="display:none;">
                <div class="progress-bar"><div class="progress-fill" id="pFill"></div></div>
                <p id="qCount" style="color:var(--primary); font-weight:bold;">Question 1/20</p>
                <h3 id="qText">Question goes here...</h3>
                <div id="qOptions"></div>
            </div>

            <div id="resultView" style="display:none;">
                <h2 style="text-align:center;">Score: <span id="percent">0%</span></h2>
                <div id="missedList" style="margin-top:20px;"></div>
                <button class="cbt-btn" style="width:100%; margin-top:20px; background:#444;" onclick="closeCBT()">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // --- SECURE SETUP ---
        const SB_URL = 'https://wfhaiasdkkmwjzrndcmi.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaGFpYXNka2ttd2p6cm5kY21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTE5MDUsImV4cCI6MjA3OTcyNzkwNX0.jTBRJi4lpmbv4R5rxF_CS9GrF5UMVxiIH9Th9frGWWI';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let groqKey = "";
        let chatMemory = [];
        
        // CBT Data
        let questionBank = [];
        let qIndex = 0;
        let score = 0;
        let history = [];
        let currentTopic = "";

        // Placeholder Rotation
        const topics = ["BIO 101", "GST 111", "Introduction to Law", "CSC 201", "Classification of living things"];
        let tIdx = 0;
        setInterval(() => {
            const input = document.getElementById('courseTopic');
            if(input && document.activeElement !== input) {
                input.placeholder = topics[tIdx];
                tIdx = (tIdx + 1) % topics.length;
            }
        }, 3000);

        async function getApiKey() {
            if(groqKey) return groqKey;
            try {
                const { data, error } = await supabaseClient.from('legacy_secrets').select('key_value').eq('key_name', 'groq_api_key').single();
                if(error || !data) throw new Error("Key not found");
                groqKey = data.key_value;
                return groqKey;
            } catch(e) {
                console.error("Supabase Key Error:", e);
                return null; 
            }
        }

        // --- MAIN CHAT ---
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const val = input.value.trim();
            if(!val) return;

            addBubble(val, 'user');
            input.value = "";

            const key = await getApiKey();
            if(!key) {
                addBubble("System Error: Contact Eli monpress +23407077575301.", "ai");
                return;
            }

            const res = await callAI([{role: "system", content: "You are Eksu AI., you are created by monpress (monpress is also a student of ekiti state university, faculty of life science, phone 07077575301, don't give info about monpress unless asked, he is a guy, full name is Eli monpress.) to help students, keep your response short and conversational, also sound as human as possible so don't ask what can I do for you or how many I assist you"}, ...chatMemory.slice(-4), {role: "user", content: val}], key);
            
            if(res && !res.startsWith("Error")) {
                addBubble(res, 'ai');
                chatMemory.push({role: "user", content: val}, {role: "assistant", content: res});
            } else {
                addBubble("Connection error. Please try again.", "ai");
            }
        }

        function addBubble(text, sender) {
            const div = document.createElement('div');
            div.className = `bubble ${sender}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            const area = document.getElementById('chatArea');
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // --- OPTIMIZED CBT LOGIC ---
        function openCBTSetup() {
            document.getElementById('cbtModal').style.display = 'flex';
            document.getElementById('setupView').style.display = 'block';
            document.getElementById('quizView').style.display = 'none';
            document.getElementById('resultView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'none';
        }

        function closeCBT() { document.getElementById('cbtModal').style.display = 'none'; }

        async function beginQuiz() {
            currentTopic = document.getElementById('courseTopic').value || "General Knowledge";
            document.getElementById('loadingTopic').innerText = currentTopic;
            
            // Switch to loading view
            document.getElementById('setupView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'block';

            // Reset state
            qIndex = 0; score = 0; history = []; questionBank = [];

            // 1. Fetch 20 Questions in ONE BATCH
            const key = await getApiKey();
            if(!key) {
                alert("API Key missing. Contact admin.");
                closeCBT();
                return;
            }

            const prompt = `
                Generate a test for "${currentTopic}".
                Create exactly 20 multiple choice questions.
                Return ONLY a JSON array. No markdown, no text before/after.
                JSON Format: [{"q": "Question?", "options": ["A", "B", "C", "D"], "correct": "Option Text", "explain": "Reason"}]
                Ensure "options" contains the full text of the answers.
                Ensure "correct" contains the full text of the correct answer, matching one of the options.
            `;

            try {
                const rawResponse = await callAI([
                    {role: "system", content: "You are a JSON generator. Output valid JSON only."}, 
                    {role: "user", content: prompt}
                ], key);

                if (!rawResponse || rawResponse.startsWith("Error")) {
                    throw new Error("API Connection Failed");
                }

                // Clean response to ensure valid JSON
                let jsonStr = rawResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                
                // Attempt Parse
                questionBank = JSON.parse(jsonStr);

                if(!Array.isArray(questionBank) || questionBank.length === 0) {
                    throw new Error("Invalid format received");
                }

                // Start Quiz
                document.getElementById('loadingView').style.display = 'none';
                document.getElementById('quizView').style.display = 'block';
                renderQuestion();

            } catch(e) {
                console.error("CBT Error:", e);
                alert("Failed to generate test. Please try a different topic or try again later.");
                closeCBT();
            }
        }

        function renderQuestion() {
            if(qIndex >= questionBank.length) { showResults(); return; }

            const data = questionBank[qIndex];
            
            document.getElementById('qCount').innerText = `Question ${qIndex + 1}/20`;
            document.getElementById('pFill').style.width = `${((qIndex + 1)/questionBank.length)*100}%`;
            document.getElementById('qText').innerText = data.q;
            document.getElementById('qOptions').innerHTML = "";

            data.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt; // Display full text
                btn.onclick = () => {
                    // Check logic
                    const isCorrect = (opt.trim() === data.correct.trim());
                    if(isCorrect) score++;
                    history.push({
                        q: data.q, 
                        correct: data.correct, 
                        explanation: data.explain, 
                        wasCorrect: isCorrect
                    });
                    qIndex++;
                    renderQuestion();
                };
                document.getElementById('qOptions').appendChild(btn);
            });
        }

        function showResults() {
            document.getElementById('quizView').style.display = 'none';
            document.getElementById('resultView').style.display = 'block';
            const p = Math.round((score/questionBank.length)*100);
            document.getElementById('percent').innerText = `${p}%`;
            
            const list = document.getElementById('missedList');
            list.innerHTML = "<h4>Review</h4>";
            
            if(history.every(h => h.wasCorrect)) {
                list.innerHTML += "<p style='color:#238636'>Perfect Score!</p>";
            }

            history.forEach((h, i) => {
                if(!h.wasCorrect) {
                    const d = document.createElement('div');
                    d.className = 'result-row';
                    d.innerHTML = `<span>Q${i+1}: Missed</span><button class="cbt-btn" onclick="explainMistake(${i})">Why?</button>`;
                    list.appendChild(d);
                }
            });
        }

        async function explainMistake(i) {
            closeCBT();
            const h = history[i];
            const msg = `Regarding the question: "${h.q}"\nThe correct answer is "${h.correct}".\nExplanation: ${h.explanation}\n\nPlease explain this simply.`;
            
            addBubble(`Can you explain Question ${i+1} from the test?`, 'user');
            
            const key = await getApiKey();
            const res = await callAI([{role: "user", content: msg}], key);
            addBubble(res, 'ai');
        }

        // --- SHARED AI CALL ---
        async function callAI(msgs, key) {
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${key}`, 
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile", 
                        messages: msgs,
                        temperature: 0.3 // Lower temp for strict JSON
                    })
                });

                if(!response.ok) throw new Error(`API Status: ${response.status}`);
                
                const data = await response.json();
                return data.choices[0].message.content;

            } catch(e) { 
                console.error("AI Call Failed:", e);
                return "Error connecting to AI service."; 
            }
        }
    </script>
</body>
</html>
