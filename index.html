
<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EksuHub Feed</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0088ff">
    <link rel="icon" href="/images/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EksuHub">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  

    
    
    <style>
        /* --- Root Variables: Dark Mode (Default) --- */
        :root {
            --primary-color: #0088ff; 
            --background-color: #121212; 
            --card-bg: #1e1e1e; 
            --text-color: #f0f0f0; 
            --text-secondary: #aaaaaa; 
            --border-color: #333333; 
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.5);
            --font-family-main: 'Inter', sans-serif; 
        }

        /* --- Light Mode Definition --- */
        :root[data-theme="light"] {
            --primary-color: #007bff; 
            --background-color: #f0f2f5; 
            --card-bg: white; 
            --text-color: #333; 
            --text-secondary: #6c757d; 
            --border-color: #e0e6ed; 
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* --- Global & Scrollbar --- */
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: var(--border-color); }

        body { 
            font-family: var(--font-family-main); 
            background-color: var(--background-color);
            margin: 0;
            color: var(--text-color);
        }
        
        /* Input Field Styling */
        #postContent, #commentContent {
            width: 100%; min-height: 70px; padding: 12px; border-radius: 10px; margin-bottom: 15px; resize: vertical; font-family: inherit;
            background-color: var(--border-color); 
            color: var(--text-color);
            border: 1px solid transparent; 
        }
        :root[data-theme="light"] #postContent, 
        :root[data-theme="light"] #commentContent {
            background-color: #e9ecef; 
            color: var(--text-color);
            border: 1px solid #ced4da;
        }

        /* Link Styling */
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s; }
        a:hover { opacity: 0.8; }

        /* --- Header and Navigation --- */
        .header {
            background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky; top: 0; z-index: 1000;
        }
        .header h1 { 
            margin: 0; font-size: 1.8em; font-weight: 800; 
            font-family: 'Georgia', serif; 
            letter-spacing: -1px;
            color: var(--primary-color); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1; 
        }
        .header h1 small {
            display: block; 
            font-size: 0.4em; 
            font-weight: 400;
            margin-top: 2px;
            vertical-align: bottom;
            opacity: 0.8;
            color: var(--text-secondary);
            font-family: var(--font-family-main);
        }
        .icon-btn { 
            background: none; border: none; color: var(--text-color); font-size: 1.6em; cursor: pointer; transition: color 0.2s, transform 0.2s; 
            position: relative;
            padding: 0 8px; 
        }
        .icon-btn:hover { color: var(--primary-color); transform: scale(1.05); }

        /* Notification Badge Style */
        .notification-badge {
            position: absolute; top: 0px; right: 0px;
            background-color: #ff4d4d; color: white;
            border-radius: 50%; padding: 2px 6px;
            font-size: 0.6em; line-height: 1;
            font-weight: bold;
            display: none; 
        }

        /* --- Hamburger Menu Sidebar --- */
        .menu-sidebar {
            position: fixed; top: 0; right: 0; width: 250px; height: 100%;
            background-color: var(--card-bg);
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.6);
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            z-index: 2000; padding-top: 75px; 
            border-left: 1px solid var(--border-color);
            overflow-y: auto; /* Ensure scrollable */
        }
        .menu-sidebar.open { transform: translateX(0); }
        .menu-item {
            display: flex; align-items: center; padding: 15px 20px;
            color: var(--text-color); text-decoration: none; font-size: 1.0em;
            border-bottom: 1px solid var(--border-color);
            position: relative; 
        }
        .menu-item i { margin-right: 15px; width: 20px; }
        .menu-item:hover { background-color: var(--border-color); color: var(--primary-color); }
        .logout-item { color: #ff4d4d !important; }

        /* --- Main Content Container --- */
        .main-container { max-width: 650px; margin: 20px auto; padding: 0 15px; }

        /* --- Post Creation --- */
        .post-card.create-post { 
            padding: 15px; 
        }
        .post-action-bar { display: flex; justify-content: space-between; align-items: center; padding: 5px 0 0px 0; }
        .post-action-bar input[type="submit"] {
            background: var(--primary-color); color: white; font-weight: 700; border: none; 
            padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: background 0.2s, transform 0.1s;
        }
        .post-action-bar input[type="submit"]:hover { background: #006aff; transform: translateY(-1px); }

        /* --- Stories/People You May Know Section --- */
        .stories-container { 
            background-color: var(--card-bg); padding: 12px 10px; border-radius: 12px; box-shadow: var(--shadow-dark); 
            margin-bottom: 25px; 
            display: flex; 
            align-items: center; 
            overflow-x: auto; 
            gap: 20px; 
            white-space: nowrap; 
        }
        .story-item { 
            text-align: center; 
            display: inline-block; 
            flex-shrink: 0; 
        } 
        .story-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); padding: 3px; transition: transform 0.3s; }
        .story-username { font-size: 0.75em; margin-top: 5px; font-weight: 500; color: var(--text-color); display: block;}
        .refresh-btn { 
            font-size: 1.3em; color: var(--primary-color); margin-left: 5px; 
            flex-shrink: 0; 
        }
        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- Post Card Styling --- */
        .post-card { 
            background-color: var(--card-bg); padding: 15px 20px; 
            border-radius: 12px; box-shadow: var(--shadow-dark); margin-bottom: 20px; 
        }
        .post-header { display: flex; align-items: center; margin-bottom: 8px; } 
        .post-avatar { 
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); margin-right: 15px; 
            font-size: 25px; line-height: 45px; background-color: var(--border-color); color: var(--text-secondary);
        }
        .post-info { display: flex; flex-direction: column; font-size: 0.9em; }
        .post-actions { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 25px; font-size: 1em; align-items: center; }
        .like-icon.liked { color: #ff4d4d; }
        .post-content-text { margin-top: 5px; margin-bottom: 10px; line-height: 1.5; word-wrap: break-word; } 

        /* --- Media Size Fixes --- */
        .post-image, .post-video { 
            width: 100%; max-width: 100%; 
            height: auto; 
            max-height: 350px; 
            object-fit: cover; 
            border-radius: 8px; 
            margin-top: 10px; 
            display: block; 
        }

        /* Comment Preview */
        .random-comment { padding: 8px; margin-top: 10px; border-radius: 8px; font-size: 0.85em; color: var(--text-color); background: var(--border-color); }
        :root[data-theme="light"] .random-comment { background: #e9ecef; }
        
        /* --- Modal Styling --- */
        #commentModal {
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            z-index: 2000; 
            display: none; 
            align-items: center; 
            justify-content: center;
        }
        #commentModalContent {
            background: var(--card-bg); 
            border-radius: 12px; 
            max-width: 550px; 
            width: 90%; 
            max-height: 80%; 
            padding: 20px; 
            overflow-y: hidden; 
            display: flex; 
            flex-direction: column;
        }
        #existingComments {
            flex-grow: 1; 
            overflow-y: auto; 
            margin-bottom: 15px; 
            padding-right: 10px; 
        }

        /* --- Notification Modal Styling (FULL PAGE) --- */
        #notificationModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--background-color); 
            z-index: 3000;
            display: none; 
            flex-direction: column;
            padding: 0;
        }
        #notificationModalContent {
            background: var(--background-color); 
            width: 100%; 
            max-height: 100%; 
            padding: 0;
            overflow-y: auto; 
            flex-grow: 1;
        }
        .notification-header { 
            background-color: var(--card-bg);
            display: flex; justify-content: space-between; align-items: center; 
            color: var(--text-color); margin: 0; 
            border-bottom: 1px solid var(--border-color); 
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 10;
        }
        .notification-header h3 {
             margin: 0; color: var(--primary-color); font-size: 1.5em;
        }
        .notification-list-container {
            padding: 15px;
        }
        .notification-item {
            display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item.unread {
            background-color: #0088ff1a; 
            border-radius: 8px;
            padding: 12px 10px;
        }
        :root[data-theme="light"] .notification-item.unread { background-color: #007bff1a; }
        
        .notification-item i { margin-right: 15px; font-size: 1.2em; color: var(--primary-color); flex-shrink: 0; }
        .notification-text { flex-grow: 1; font-size: 0.95em; line-height: 1.4; }
        .notification-time { font-size: 0.7em; color: var(--text-secondary); margin-left: 10px; flex-shrink: 0; }
        .mark-read-btn {
            background: var(--primary-color); color: white; border: none; 
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em;
            transition: background 0.2s;
        }
        .close-notif-btn {
            background: none; border: none; color: var(--text-color); font-size: 1.5em; cursor: pointer;
        }
        
        /* --- PWA Prompt Styling --- */
        .pwa-prompt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.7); 
            display: none; justify-content: center; align-items: center;
            z-index: 4000; 
        }
        .pwa-prompt-content {
            background: var(--card-bg); padding: 30px; border-radius: 10px; 
            box-shadow: var(--shadow-dark); text-align: center;
            width: 90%; max-width: 350px; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .pwa-prompt-content h2 {
            margin-top: 0; color: var(--primary-color); font-size: 1.5rem; margin-bottom: 20px;
        }
        .pwa-install-button {
            background-color: #4CAF50; color: white; padding: 12px 20px; border: none; 
            border-radius: 5px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
            width: 100%; margin-top: 15px; transition: background-color 0.2s;
        }
        .ios-step { display: flex; align-items: center; text-align: left; margin-bottom: 10px; font-size: 0.95rem; color: var(--text-secondary);}
        .ios-step i { font-size: 1.5rem; margin-right: 10px; color: var(--primary-color); }
        .pwa-icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 10px; }

        /* --- Market Product Card (New) --- */
        .market-card {
            background-color: var(--card-bg); padding: 15px; border-radius: 12px;
            box-shadow: var(--shadow-dark); margin-bottom: 20px;
            display: flex; align-items: center; gap: 15px;
            border: 1px solid var(--primary-color)33; /* Subtle accent border */
            cursor: pointer;
            transition: transform 0.2s;
        }
        .market-card:hover {
            transform: translateY(-2px);
        }
        .market-card img {
            width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0;
            border: 2px solid var(--primary-color)99;
        }
        .market-info {
            flex-grow: 1;
        }
        .market-info h4 {
            margin: 0 0 5px 0; font-size: 1.1em; color: var(--primary-color);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .market-info p {
            margin: 0; font-size: 0.9em; color: var(--text-secondary);
        }
        .market-info .price {
            font-size: 1.1em; font-weight: 700; color: #4CAF50; /* Green for price */
            margin-top: 5px;
        }
#enableNotifications {
  background: linear-gradient(135deg, #6e8efb, #a777e3);
  color: white;
  padding: 6px 8px;
  border: none;
  border-radius: 12px;
  font-family: 'Inter', sans-serif;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(110, 142, 251, 0.4);
  transition: all 0.3s ease;
  width:130px;
  height:60px;
  opacity:73.0%;
}

#enableNotifications:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(110, 142, 251, 0.6);
  filter: brightness(1.1);
  opacity:100%;
}

#enableNotifications:active {
  transform: translateY(1px);
}

    </style>
</head>
    


    <div id="android-prompt-overlay" class="pwa-prompt-overlay">
      <div class="pwa-prompt-content">
        <i class="fab fa-android pwa-icon"></i>
        <h2>Install App</h2>
        <p style="color: var(--text-color);">Install the app for a faster, full-screen experience!</p>
        <button id="pwa-install-button" class="pwa-install-button">
            <i class="fas fa-download"></i> Install App
        </button>
      </div>
    </div>

    <div id="ios-prompt-overlay" class="pwa-prompt-overlay">
        <div class="pwa-prompt-content">
            <i class="fab fa-apple pwa-icon"></i>
            <h2>Add to Home Screen</h2>
            <p>Follow these quick steps to install on your iPhone/iPad:</p>
            <div class="ios-step">
                <i class="fa-solid fa-arrow-up-from-bracket"></i>
                <span>Tap the **Share** button at the bottom of the screen.</span>
            </div>
            <div class="ios-step">
                <i class="fa-solid fa-plus-square"></i>
                <span>Scroll down and tap **Add to Home Screen**.</span>
            </div>
            <button class="pwa-install-button" style="background-color: var(--border-color);" onclick="document.getElementById('ios-prompt-overlay').style.display='none'">
                Got It
            </button>
        </div>
    </div>
    <div id="commentModal" style="display: none;">
        <div id="commentModalContent">
            
            <h3 style="color: var(--primary-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; flex-shrink: 0;"><i class="fas fa-reply"></i> Comments</h3>
            
            <div id="commentingOnPostPreview" style="margin-bottom: 15px; padding: 10px; background: var(--border-color); border-radius: 8px; font-size: 0.9em; flex-shrink: 0;">
                Loading post preview...
            </div>

            <div id="existingComments">
                <p style="text-align: center; color: var(--text-secondary);">No comments yet.</p>
            </div>

            <form id="commentForm" style="flex-shrink: 0; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <input type="hidden" id="postIdToComment">
                <textarea id="commentContent" placeholder="Write your comment here..." required></textarea>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <p id="commentStatus" style="font-size: 0.9em; color: var(--text-secondary); margin: 0;"></p>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" onclick="document.getElementById('commentModal').style.display='none'" style="background: var(--border-color); color: var(--text-color); border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: background 0.2s;">Cancel</button>
                        <input type="submit" value="Submit Comment" style="background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="notificationModal">
        <header class="notification-header">
            <button type="button" onclick="toggleNotificationModal()" class="close-notif-btn" title="Close">
                <i class="fas fa-arrow-left"></i> 
            </button>
            <h3>Notifications</h3>
            <button class="mark-read-btn" id="markAllReadBtn">Mark All As Read</button>
        </header>
        
        <div id="notificationModalContent">
            <div id="notificationsList" class="notification-list-container">
                <p style="text-align: center; color: var(--text-secondary);">Loading notifications...</p>
            </div>
        </div>
    </div>


    <header class="header">
        <div class="header-left">
            <h1 id="headerTitle">
                EksuHub
                <small id="usernameDisplay">Feed</small>
            </h1>
        </div>
        <div class="header-right">
            <button class="icon-btn" id="notificationBtn" title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount"></span>
            </button>
            
            <button class="icon-btn" id="menuToggleBtn" title="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <div id="menuSidebar" class="menu-sidebar">
        
        <a href="feed.html" class="menu-item" title="Feed">
            <i class="fas fa-home"></i> Feed
        </a>

        <a href="#" id="menuProfileLink" class="menu-item" title="My Profile">
            <i class="fas fa-user-circle"></i> My Profile
        </a>
        
        <a href="academics.html" class="menu-item" title="Academics">
            <i class="fas fa-graduation-cap"></i> Academics
        </a>
        <a href="market.html" class="menu-item" title="Marketplace">
            <i class="fas fa-store"></i> Market
        </a>
        <a href="find.html" class="menu-item" title="Find">
            <i class="fas fa-map-marker-alt"></i> Find
        </a>
        <a href="chat.html" class="menu-item" id="menuChatLink" title="Chat/Messages">
            <i class="fas fa-comment-alt"></i> Chat
            <span class="notification-badge" id="chatNotificationCount" style="right: 5px;"></span>
        </a>
        <a href="confession.html" class="menu-item" id="menuConfessionLink" title="Confession">
            <i class="fas fa-mask" style="color:orangered;"></i> Confession
        </a>
        <a href="#" id="menuLogoutLink" class="menu-item logout-item" title="Logout">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
        <br><br><br><br><br><br>
        <button id="enableNotifications">
  <i class="fa-solid fa-bell"></i> Activate Notifications
</button>



    </div>

    <div class="main-container">
        
        <h4><i class="fas fa-users"></i> People You May Know</h4>
        <div class="stories-container">
            <button class="refresh-btn icon-btn" id="refreshStoriesBtn" title="Refresh Suggestions">
                <i class="fas fa-sync"></i>
            </button>
            <div id="storiesContent" style="display: flex; gap: 15px; white-space: nowrap;">
                <p style="font-size: 0.9em; margin: auto; color: var(--text-secondary);">Loading suggestions...</p>
            </div>
        </div>


       
        <div class="post-card create-post"> 
            <form id="postForm">
                <textarea id="postContent" placeholder="What's on your mind today?" required></textarea>
                
                <div class="post-action-bar">
                    <button type="button" onclick="document.getElementById('postMediaFile').click()" class="icon-btn" title="Add Photo or Video" style="color: var(--primary-color); font-size: 1.3em;">
                        <i class="fas fa-image"></i>
                    </button>
                    
                    <input type="file" id="postMediaFile" accept="image/*,video/*" style="display: none;">
                    
                    <input type="submit" value="Post">
                </div>
                
                <p id="postStatus" style="font-size: 0.8em; color: var(--text-secondary); margin-top: -10px;"></p>
            </form>
        </div>
        <div class='onesignal-customlink-container'></div>
        <h3><i class="fas fa-stream"></i> Chronological Feed</h3>
        <div id="feedContainer">
            <p style="color: var(--text-secondary);">Loading posts...</p>
        </div>

        <div class="load-more-container" style="text-align: center; margin: 30px 0;">
            <button id="load-more-btn" onclick="loadNextPage()" style="
                background: var(--card-bg); 
                color: var(--primary-color); 
                border: 1px solid var(--primary-color); 
                padding: 10px 25px; 
                border-radius: 20px; 
                cursor: pointer; 
                font-weight: 600;
                transition: background-color 0.2s;
            ">
                Load More Posts
            </button>
        </div>
        </div>

    <script>
        // =================================================================================
        // --- CONFIGURATION ---
        // =================================================================================
        // !! IMPORTANT !! Replace these with your actual keys
        const SUPABASE_URL = 'https://wfhaiasdkkmwjzrndcmi.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndmaGFpYXNka2ttd2p6cm5kY21pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTE5MDUsImV4cCI6MjA3OTcyNzkwNX0.jTBRJi4lpmbv4R5rxF_CS9GrF5UMVxiIH9Th9frGWWI';
        const REDIRECT_PAGE = 'auth.html'; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        

        
        // --- FEED ALGORITHM CONFIGURATION ---
        const FEED_DISTRIBUTION_WEIGHTS = {
            post: 6, // 6 out of 10 slots go to regular posts
            newUser: 2, // 2 out of 10 slots go to new user announcements
            marketProduct: 2 // 2 out of 10 slots go to market products
        };
        const POSTS_PER_PAGE = 20; // How many regular posts to fetch in one batch
        let postOffset = 0;        // Tracks the starting point for the next fetch
        let allPostsLoaded = false; // Flag to stop fetching when the end is reached
        
        // --- DOM Elements ---
        const postForm = document.getElementById('postForm');
        const postStatus = document.getElementById('postStatus');
        const feedContainer = document.getElementById('feedContainer');
        const headerTitle = document.getElementById('headerTitle');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const notificationBtn = document.getElementById('notificationBtn');
        const storiesContent = document.getElementById('storiesContent');
        const refreshStoriesBtn = document.getElementById('refreshStoriesBtn');
        const notificationCount = document.getElementById('notificationCount');
        const chatNotificationCount = document.getElementById('chatNotificationCount');
        
        // Menu Elements
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const menuSidebar = document.getElementById('menuSidebar');
        const menuProfileLink = document.getElementById('menuProfileLink');
        const menuLogoutLink = document.getElementById('menuLogoutLink');
        const menuChatLink = document.getElementById('menuChatLink');

        // Comment Modal Elements
        const commentModal = document.getElementById('commentModal');
        const commentForm = document.getElementById('commentForm');
        const postIdToComment = document.getElementById('postIdToComment');
        const commentingOnPostPreview = document.getElementById('commentingOnPostPreview');
        const commentContent = document.getElementById('commentContent');
        const commentStatus = document.getElementById('commentStatus');
        const existingComments = document.getElementById('existingComments'); 
        
        // Notification Modal Elements
        const notificationModal = document.getElementById('notificationModal');
        const notificationsList = document.getElementById('notificationsList');
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        
        // PWA Elements
        const pwaInstallButton = document.getElementById("pwa-install-button");
        const androidPromptOverlay = document.getElementById('android-prompt-overlay');
        const iosPromptOverlay = document.getElementById('ios-prompt-overlay');
        let deferredPrompt;


        let currentUserId = null; 
        const PLACEHOLDER_AVATAR = 'https://via.placeholder.com/50/383838/f0f0f0?text=E'; 
        
        // =================================================================================
        // --- UTILITY FUNCTIONS ---
        // =================================================================================
        
        function getProfileUrl(userId) {
            return `profile.html?id=${userId}`;
        }
        
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;

            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "m";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "min";
            return "just now";
        }

        async function compressImage(file) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        const maxWidth = 800;
                        const scaleFactor = img.width > maxWidth ? maxWidth / img.width : 1;
                        canvas.width = img.width * scaleFactor;
                        canvas.height = img.height * scaleFactor;

                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        canvas.toBlob(blob => {
                            if (!blob) return reject(new Error("Canvas compression failed."));
                            const compressedFile = new File([blob], file.name, {
                                type: file.type,
                                lastModified: Date.now(),
                            });
                            resolve(compressedFile);
                        }, file.type, 0.7); 
                    };
                    img.onerror = error => reject(new Error("Failed to load image for compression."));
                };
                reader.onerror = error => reject(new Error("Failed to read file for compression."));
            });
        }
        
        async function uploadMedia(userId, file) {
            const fileExt = file.name.split('.').pop();
            const filePath = `${userId}/${Date.now()}.${fileExt}`; 
            const bucketName = 'media';

            const { error } = await supabaseClient.storage
                .from(bucketName)
                .upload(filePath, file);

            if (error) {
                throw new Error(`Media upload failed: ${error.message}`);
            }
            
            const { data: publicUrlData } = supabaseClient.storage
                .from(bucketName)
                .getPublicUrl(filePath);
            
            return publicUrlData.publicUrl;
        }


        async function checkUserSession() {
            const { data: { user }, error } = await supabaseClient.auth.getUser();

            if (error || !user) {
                window.location.href = REDIRECT_PAGE;
                return null;
            }
            
            currentUserId = user.id;

            if (menuProfileLink) {
                menuProfileLink.href = getProfileUrl(currentUserId);
            }

            const { data: profile } = await supabaseClient
                .from('users')
                .select('username')
                .eq('id', user.id)
                .single();
            
            if (profile && profile.username) {
                const profileLinkUrl = getProfileUrl(user.id);
                // Update header with username link
                headerTitle.innerHTML = `
                    EksuHub
                    <small id="usernameDisplay">
                        <a href="${profileLinkUrl}" style="color: inherit; text-decoration: none;">@${profile.username}</a>
                    </small>`;
            } else {
                 headerTitle.innerHTML = 'EksuHub<small>Feed</small>';
            }
            
            return user;
        }

        // --- THEME LOGIC ---
        function updateThemeUI(isDarkMode) {
            if (isDarkMode) {
                document.body.setAttribute('data-theme', 'dark');
            } else {
                document.body.setAttribute('data-theme', 'light');
            }
        }
        
        // --- MENU LOGIC ---
        function toggleMenu() {
            menuSidebar.classList.toggle('open');
        }

        document.addEventListener('click', (e) => {
            if (menuSidebar.classList.contains('open') && 
                !menuSidebar.contains(e.target) && 
                e.target !== menuToggleBtn && 
                !menuToggleBtn.contains(e.target)) {
                menuSidebar.classList.remove('open');
            }
        });
        
        // --- STORY/SUGGESTION LOGIC ---

        async function fetchSuggestedUsers() {
            const { data } = await supabaseClient
                .from('users')
                .select('id, username, avatar_url')
                .neq('id', currentUserId) 
                .not('username', 'is', null) 
                .limit(50);
            
            if (!data) return [];
            
            // Randomize and limit to 8
            const shuffled = data.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 8);
        }

        async function renderSuggestedUsers() {
            if (!currentUserId) {
                 storiesContent.innerHTML = '<p style="font-size: 0.9em; margin: auto; color: var(--text-secondary);">Log in to see suggestions.</p>';
                 return;
            }
            storiesContent.innerHTML = '<p style="font-size: 0.9em; margin: auto; color: var(--text-secondary);">Loading suggestions...</p>';
            
            const suggestions = await fetchSuggestedUsers();

            storiesContent.innerHTML = '';
            
            if (suggestions.length === 0) {
                 storiesContent.innerHTML = '<p style="font-size: 0.9em; margin: auto; color: var(--text-secondary);">No users found yet.</p>';
                 return;
            }
            
            suggestions.forEach(user => {
                const avatar = user.avatar_url; 
                const userProfileUrl = getProfileUrl(user.id); 
                
                let avatarHtml;
                if (avatar) {
                    avatarHtml = `<img src="${avatar}" class="story-avatar" alt="${user.username}'s avatar" onerror="this.onerror=null; this.src='${PLACEHOLDER_AVATAR}'">`;
                } else {
                    avatarHtml = `<i class="fas fa-user-circle story-avatar" style="line-height: 60px; border: none;"></i>`;
                }
                
                storiesContent.innerHTML += `
                    <a href="${userProfileUrl}" class="story-item" title="View @${user.username}'s Profile" style="text-decoration: none;">
                        ${avatarHtml}
                        <span class="story-username">${user.username}</span>
                    </a>
                `;
            });
        }
        
        // --- MARKETPLACE PRODUCT LOGIC (NEW) ---
        
        async function fetchMarketProducts() {
            const { data, error } = await supabaseClient
                .from('products') 
                .select('id, name, price, image_url, created_at')
                .order('created_at', { ascending: false })
                .limit(10); 
                
            if (error) { console.error('Error fetching market products:', error); return []; }
            
            const marketProducts = data.map(product => ({
                id: product.id,
                type: 'marketProduct', // Identifier for the feed algorithm
                created_at: product.created_at,
                name: product.name,
                price: product.price,
                image_url: product.image_url,
                // Add a user property for consistency, although not strictly needed for rendering
                user: { username: 'Marketplace' } 
            }));
            
            return marketProducts;
        }
        
        function renderMarketCard(product) {
            return `
                <a href="market.html?product_id=${product.id}" class="market-card">
                    <img src="${product.image_url || 'https://via.placeholder.com/80x80?text=Product'}" alt="${product.name}">
                    <div class="market-info">
                        <h4><i class="fas fa-tag"></i> ${product.name}</h4>
                        <p>Listed ${timeAgo(product.created_at)}</p>
                        <p class="price">â‚¦${product.price ? product.price.toLocaleString() : 'N/A'}</p>
                    </div>
                </a>
            `;
        }


        // --- POSTING, LIKES, COMMENTS LOGIC ---
        
        async function handlePostCreation(event) {
            event.preventDefault();

            if (!currentUserId) { postStatus.textContent = 'Error: You must be logged in to post.'; return; }

            postStatus.textContent = 'Processing post...';
            
            const content = document.getElementById('postContent').value.trim();
            const mediaFile = document.getElementById('postMediaFile').files[0];
            let mediaUrl = null; 
            
            if (content.length === 0 && !mediaFile) { postStatus.textContent = 'Error: Post content or an image/video file is required.'; return; }
            
            let fileToUpload = mediaFile;
            
            if (mediaFile) {
                if (mediaFile.type.startsWith('image/')) {
                    try {
                        postStatus.textContent = 'Compressing image...';
                        fileToUpload = await compressImage(mediaFile);
                    } catch (e) {
                        postStatus.textContent = `Error compressing image: ${e.message}`; return;
                    }
                }
                
                try {
                    postStatus.textContent = 'Uploading media file...';
                    mediaUrl = await uploadMedia(currentUserId, fileToUpload);
                } catch (e) {
                    postStatus.textContent = `Error during media upload. Check console for details.`; return;
                }
            }

            const { error: msgError } = await supabaseClient
                .from('messages')
                .insert([{
                    user_id: currentUserId,
                    content: content,
                    image_url: mediaUrl,
                }]);

            if (msgError) {
                postStatus.textContent = `Error creating post: ${msgError.message}`;
            } else {
                postStatus.textContent = 'Post created successfully! Refreshing feed...';
                postForm.reset(); 
                document.getElementById('postMediaFile').value = '';
                // Refresh the feed after a post is created
                setTimeout(() => fetchFeedPosts(0, true), 1000); // Call initial fetch
            }
        }
        
        /** Fetches and displays posts for newly registered users. */
        async function fetchNewUserAnnouncements() {
            const { data: newUsers, error } = await supabaseClient
                .from('users')
                .select('username, created_at')
                .order('created_at', { ascending: false })
                .limit(5); // Get a few recent ones
                
            if (error) { console.error('Error fetching new users:', error); return []; }

            const newUserAnnouncements = newUsers.map(user => {
                return {
                    id: `new-user-${user.username}-${user.created_at}`, 
                    type: 'newUser', // Identifier for the feed algorithm
                    created_at: user.created_at,
                    content: `ðŸŽ‰ Welcome! **@${user.username}** just joined the Hub! Give them a follow.`,
                    user: { username: 'EksuHub Admin' }
                };
            });
            return newUserAnnouncements;
        }
        
        function renderNewUserAnnouncement(announcement) {
             return `
                <div class="post-card" style="border: 2px solid var(--primary-color); background-color: var(--primary-color)1a;">
                    <div class="post-header">
                        <i class="fas fa-bullhorn post-avatar" style="line-height: 45px; border: none; background-color: var(--primary-color); color: white;"></i>
                        <div class="post-info">
                            <strong>EksuHub Admin</strong>
                            <span>System Announcement | ${timeAgo(announcement.created_at)}</span>
                        </div>
                    </div>
                    <p class="post-content-text" style="font-weight: 600;">${announcement.content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                </div>`;
        }


        // --- NEW: Post Element Creation Helper (Moved rendering logic here) ---
        function createPostElement(post, commentsMap) {
            const userId = post.user ? post.user.id : null;
            const username = post.user ? post.user.username : 'Anonymous User';
            const department = post.user ? post.user.department : '';
            const avatarUrl = post.user && post.user.avatar_url;
            const time = timeAgo(post.created_at);
            
            const heartReactions = post.reactions ? post.reactions.filter(r => r.emoji === 'heart') : [];
            const postLikes = heartReactions.length;
            const hasUserLiked = heartReactions.some(r => r.user_id === currentUserId); 
            
            const postComments = commentsMap[post.id] || [];
            const inlineComment = postComments.length > 0 ? 
                `<div class="random-comment"><strong>@${postComments[0].user.username}</strong>: ${postComments[0].content.substring(0, 50)}${postComments[0].content.length > 50 ? '...' : ''}</div>` : 
                '';
            
            let mediaHtml = '';
            if (post.image_url) {
                const url = post.image_url.toLowerCase();
                const mediaClass = (url.endsWith('.mp4') || url.endsWith('.mov') || url.endsWith('.webm')) ? 'post-video' : 'post-image';
                
                if (mediaClass === 'post-video') {
                    mediaHtml = `<video src="${post.image_url}" controls class="${mediaClass}"></video>`;
                } else {
                    mediaHtml = `<img src="${post.image_url}" class="${mediaClass}" alt="Post Image" onerror="this.onerror=null; this.src='${PLACEHOLDER_AVATAR}'">`;
                }
            }
            
            let avatarHtml;
            if (avatarUrl) {
                avatarHtml = `<img src="${avatarUrl}" class="post-avatar" alt="${username}'s avatar" onerror="this.onerror=null; this.src='${PLACEHOLDER_AVATAR}'">`;
            } else {
                avatarHtml = `<i class="fas fa-user-circle post-avatar" style="line-height: 45px; border: none;"></i>`;
            }
            
            let postContentHtml = post.content.trim() 
                ? `<p class="post-content-text">${post.content}</p>` 
                : `<p class="post-content-text" style="color: var(--text-secondary); font-style: italic; font-size: 0.9em; padding-top: 10px;">
                    <i class="fas ${post.image_url ? 'fa-image' : 'fa-info-circle'}" style="margin-right: 5px;"></i> 
                    ${post.image_url ? 'Media post with no description.' : 'No content provided.'}
                   </p>`;


            const postElement = document.createElement('div');
            postElement.className = 'post-card';

            const userProfileUrl = getProfileUrl(userId);

            postElement.innerHTML = `
                <div class="post-header">
                    <a href="${userProfileUrl}" style="text-decoration: none; display: contents;">
                        ${avatarHtml}
                    </a>
                    <div class="post-info">
                        <a href="${userProfileUrl}" style="color: inherit; text-decoration: none;">
                            <strong>@${username}</strong>
                        </a>
                        <span>${department} | ${time}</span>
                    </div>
                </div>
                
                ${postContentHtml} 
                
                ${mediaHtml}
                
                <div class="post-actions">
                    <span class="action-button like-toggle" data-post-id="${post.id}" onclick="handleLikeClick('${post.id}')">
                        <i class="fas fa-heart like-icon ${hasUserLiked ? 'liked' : ''}"></i> 
                        <span class="like-count">${postLikes}</span>
                    </span>
                    
                    <span class="action-button comment-btn" data-post-id="${post.id}" onclick="handleCommentClick('${post.id}')">
                        <i class="fas fa-comment-dots"></i> 
                        <span class="comment-count">${postComments.length}</span>
                    </span>
                </div>

                ${inlineComment}
            `;
            return postElement;
        }

        /**
         * Asynchronously fetches a batch of feed posts and appends them to the container.
         * @param {number} offset The starting index for fetching regular 'messages' posts.
         * @param {boolean} isInitialLoad If true, clears the feed and fetches non-paginated content (announcements/products).
         */
        async function fetchFeedPosts(offset = 0, isInitialLoad = true) {
            const loadMoreButton = document.getElementById('load-more-btn');

            if (isInitialLoad) {
                // Clear the feed container only on the first load
                feedContainer.innerHTML = '<p style="color: var(--text-secondary);">Loading latest posts...</p>';
                if (loadMoreButton) loadMoreButton.style.display = 'none'; // Hide button during initial fetch
                postOffset = 0; // Reset offset if called as initial load
                allPostsLoaded = false;
            } else if (loadMoreButton) {
                // Show loading state for subsequent fetches
                loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                loadMoreButton.disabled = true;
            }
            
            // 1. Fetch data sources concurrently
            // NOTE: Only regular 'messages' posts are paginated using range(offset, limit)
            const [{ data: posts, error: postError }, newUserAnnouncements, marketProducts] = await Promise.all([
                supabaseClient
                    .from('messages')
                    .select(`
                        id, content, image_url, created_at,
                        user:users (id, username, avatar_url, faculty, department),
                        reactions(id, user_id, emoji)
                    `)
                    .is('replied_to_id', null)
                    .order('created_at', { ascending: false })
                    .range(offset, offset + POSTS_PER_PAGE - 1), // <-- MODIFIED: Pagination logic
                
                // Non-paginated content (Announcements/Products) is only fetched on the initial load
                isInitialLoad ? fetchNewUserAnnouncements() : Promise.resolve([]),
                isInitialLoad ? fetchMarketProducts() : Promise.resolve([])
            ]);
            
            if (postError) { 
                if (isInitialLoad) {
                    feedContainer.innerHTML = `<p style="color: red;">Error fetching feed: ${postError.message}</p>`;
                } else if (loadMoreButton) {
                    loadMoreButton.innerHTML = 'Error Loading';
                }
                updateLoadMoreButtonState(); // Re-enable/reset button on error
                return; 
            }

            // Check if we received fewer posts than expected, meaning we've hit the end
            if (posts.length < POSTS_PER_PAGE) {
                allPostsLoaded = true;
            }

            // 2. Prepare data pools
            const postPool = posts.map(p => ({ ...p, type: 'post' }));
            const newUserPool = newUserAnnouncements;
            const marketPool = marketProducts;
            
            let combinedFeed = [];
            const availableItems = {
                post: postPool.slice(),
                newUser: newUserPool.slice(),
                marketProduct: marketPool.slice()
            };

            // 3. Simple Weighted Feed Distribution Algorithm
            const distributionSlots = [];
            for (const type in FEED_DISTRIBUTION_WEIGHTS) {
                // Only include non-post types on the initial load
                if (type !== 'post' && !isInitialLoad) continue; 
                
                for (let i = 0; i < FEED_DISTRIBUTION_WEIGHTS[type]; i++) {
                    distributionSlots.push(type);
                }
            }
            
            // Determine the size of the combined feed based on the available items in this batch
            const totalAvailableItems = availableItems.post.length + availableItems.newUser.length + availableItems.marketProduct.length;

            // Randomly pick a slot type and draw an item from the corresponding pool
            while (combinedFeed.length < totalAvailableItems) {
                if (distributionSlots.length === 0) break; 
                
                const randomIndex = Math.floor(Math.random() * distributionSlots.length);
                const slotType = distributionSlots[randomIndex];
                
                // Try to draw the item
                if (availableItems[slotType] && availableItems[slotType].length > 0) {
                    const item = availableItems[slotType].shift(); 
                    combinedFeed.push(item);
                    
                    // Remove the slot
                    distributionSlots.splice(randomIndex, 1);
                } else {
                    // If the pool is empty, remove the slot permanently and re-try
                    distributionSlots.splice(randomIndex, 1);
                }
            }
            
            // 4. Sort the final combined feed by creation date
            combinedFeed.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // 5. Fetch comments for all POST type items
            const postIds = combinedFeed.filter(item => item.type === 'post').map(p => p.id); 
            let commentsMap = {};
            if (postIds.length > 0) {
                 const { data: commentsData } = await supabaseClient
                    .from('messages')
                    .select(`replied_to_id, content, created_at, user:users(username)`)
                    .in('replied_to_id', postIds)
                    .order('created_at', { ascending: false }); 
                    
                commentsMap = commentsData ? commentsData.reduce((acc, c) => {
                    acc[c.replied_to_id] = acc[c.replied_to_id] || [];
                    acc[c.replied_to_id].push(c);
                    return acc;
                }, {}) : {};
            }

            // 6. Render the combined feed
            if (isInitialLoad) {
                // If it's the first load, replace the 'Loading...' message
                feedContainer.innerHTML = '';
            }
            
            if (combinedFeed.length === 0 && isInitialLoad) { 
                feedContainer.innerHTML = '<p style="color: var(--text-secondary);">No posts, announcements, or products to display yet.</p>'; 
            } else {
                // Append the new content for both initial and subsequent loads
                combinedFeed.forEach(item => {
                    // Use appendChild for 'post' elements
                    if (item.type === 'post') {
                        const postElement = createPostElement(item, commentsMap); 
                        feedContainer.appendChild(postElement);
                    } else if (item.type === 'newUser') {
                        // Use insertAdjacentHTML for non-post string content
                        feedContainer.insertAdjacentHTML('beforeend', renderNewUserAnnouncement(item));
                    } else if (item.type === 'marketProduct') {
                        feedContainer.insertAdjacentHTML('beforeend', renderMarketCard(item));
                    }
                });
            }

            // Update global offset only after successful rendering
            if (posts.length > 0) {
                postOffset += posts.length;
            }
            
            // Finally, update the "Load More" button state
            updateLoadMoreButtonState();
        }

        // --- PAGINATION CONTROL FUNCTIONS (NEW) ---

        /**
         * Helper function to call the main fetch with the current global offset.
         * Called when the "Load More" button is clicked.
         */
        function loadNextPage() {
            // Calling with the current global offset and isInitialLoad = false
            fetchFeedPosts(postOffset, false); 
        }

        /**
         * Manages the visibility and state of the Load More button.
         */
        function updateLoadMoreButtonState() {
            const loadMoreButton = document.getElementById('load-more-btn');
            if (!loadMoreButton) return;
            
            if (allPostsLoaded) {
                // Hide button and show an "End of Feed" message
                loadMoreButton.style.display = 'none'; 
                
                // Check if "End of Feed" message already exists before adding it
                if (!document.getElementById('end-of-feed-msg')) {
                    const endMsg = document.createElement('p');
                    endMsg.id = 'end-of-feed-msg';
                    endMsg.textContent = 'You have reached the end of the feed.';
                    endMsg.style.cssText = 'text-align: center; color: var(--text-secondary); margin-top: 20px;';
                    // Insert after the feed container
                    feedContainer.insertAdjacentElement('afterend', endMsg); 
                }
            } else {
                // Reset the button state and re-enable it
                loadMoreButton.style.display = 'block';
                loadMoreButton.innerHTML = 'Load More Posts';
                loadMoreButton.disabled = false;
                
                // Remove the "End of Feed" message if it exists
                const endMsg = document.getElementById('end-of-feed-msg');
                if (endMsg) endMsg.remove();
            }
        }
        
        async function handleLikeClick(postId) {
            if (!currentUserId) { alert("You must be logged in to like posts."); return; }
            
            const postActionSpan = document.querySelector(`.like-toggle[data-post-id="${postId}"]`);
            if (!postActionSpan) { console.error("Like button element not found for post:", postId); return; }
            
            const likeIcon = postActionSpan.querySelector('.like-icon');
            const likeCountSpan = postActionSpan.querySelector('.like-count');
            
            postActionSpan.style.pointerEvents = 'none';

            const { data: existingReaction } = await supabaseClient
                .from('reactions')
                .select('id')
                .eq('message_id', postId)
                .eq('user_id', currentUserId)
                .eq('emoji', 'heart')
                .maybeSingle(); 

            let newCount = parseInt(likeCountSpan.textContent);
            let error = null;

            if (existingReaction) {
                const res = await supabaseClient.from('reactions').delete().eq('id', existingReaction.id);
                error = res.error;

                if (!error) { 
                    newCount--; 
                    likeIcon.classList.remove('liked'); 
                }
            } else {
                const res = await supabaseClient.from('reactions').insert([{ message_id: postId, user_id: currentUserId, emoji: 'heart' }]);
                error = res.error;

                if (!error) { 
                    newCount++; 
                    likeIcon.classList.add('liked'); 
                }
            }
                        if (error) {
                // Expanded logging to reveal the hidden object data
                console.error('Like action failed. Full error object:', error);
                console.log('Error Message:', error.message);
                console.log('Error Code:', error.code);
                console.log('Error Details:', error.details);

                alert('Action failed: ' + (error.message || 'Check console for details.'));
                likeIcon.classList.toggle('liked', !likeIcon.classList.contains('liked'));
            } else {
                likeCountSpan.textContent = newCount;
                likeIcon.animate([
                    { transform: 'scale(1.5)', color: '#ff4d4d' },
                    { transform: 'scale(1)' }
                ], { duration: 300, easing: 'ease-out' });
            }

            postActionSpan.style.pointerEvents = 'auto';
        }

           
        // --- Comment Functions ---
        function renderExistingComments(comments) {
            if (comments.length === 0) { existingComments.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No comments yet. Be the first!</p>'; return; }
            existingComments.innerHTML = '';
            comments.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            comments.forEach(comment => {
                const username = comment.user ? comment.user.username : 'Deleted User';
                const avatarUrl = comment.user && comment.user.avatar_url;
                const time = new Date(comment.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let avatarHtml;
                if (avatarUrl) {
                    avatarHtml = `<img src="${avatarUrl}" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;" onerror="this.onerror=null; this.src='${PLACEHOLDER_AVATAR}'">`;
                } else {
                    avatarHtml = `<i class="fas fa-user-circle" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover; font-size: 20px; line-height: 35px; text-align: center; background-color: var(--border-color); color: var(--text-secondary);"></i>`;
                }

                existingComments.innerHTML += `
                    <div style="display: flex; margin-bottom: 15px; gap: 10px; padding: 10px; border-radius: 8px;">
                        ${avatarHtml}
                        <div style="flex-grow: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: var(--primary-color); font-size: 0.9em;">@${username}</strong>
                                <span style="font-size: 0.75em; color: var(--text-secondary);">${time}</span>
                            </div>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: var(--text-color); word-break: break-word;">${comment.content}</p>
                        </div>
                    </div>
                `;
            });
            existingComments.scrollTop = existingComments.scrollHeight;
        }

        async function handleCommentClick(postId) {
            if (!currentUserId) { alert("You must be logged in to comment."); return; }
            
            commentStatus.textContent = 'Loading comments...';
            existingComments.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading...</p>'; 
            
            const { data: post, error: postError } = await supabaseClient
                .from('messages')
                .select(`content, user:users(username, avatar_url)`)
                .eq('id', postId)
                .single();
                
            if (postError || !post) { commentingOnPostPreview.innerHTML = 'Error loading post preview.'; return; }
            
            const { data: comments, error: commentsError } = await supabaseClient
                .from('messages')
                .select(`id, content, created_at, user:users(username, avatar_url)`)
                .eq('replied_to_id', postId)
                .order('created_at', { ascending: true }); 

            if (commentsError) { existingComments.innerHTML = `<p style="color: red;">Error fetching comments: ${commentsError.message}</p>`; }
            
            postIdToComment.value = postId;
            commentingOnPostPreview.innerHTML = `
                <strong style="color: var(--primary-color);">Replying to @${post.user.username}:</strong> 
                ${post.content.substring(0, 70)}${post.content.length > 70 ? '...' : ''}
            `;
            
            renderExistingComments(comments || []);
            commentModal.style.display = 'flex';
            commentContent.focus(); 
            commentStatus.textContent = '';
        }

        async function handleCommentSubmission(event) {
            event.preventDefault();
            commentStatus.textContent = 'Submitting comment...';
            
            const content = commentContent.value.trim();
            const repliedToId = postIdToComment.value;
            
            if (!content) { commentStatus.textContent = 'Please enter a comment.'; return; }
            
            const { error } = await supabaseClient
                .from('messages')
                .insert([ { user_id: currentUserId, content: content, replied_to_id: repliedToId, }, ]);

            if (error) {
                commentStatus.textContent = `Error: ${error.message}`;
            } else {
                commentStatus.textContent = 'Comment posted successfully!';
                commentContent.value = ''; 
                
                // Keep modal open, update comments immediately
                await handleCommentClick(repliedToId); 
                
                // Find the post element on the feed and update its comment count locally
                const postElement = document.querySelector(`.comment-btn[data-post-id="${repliedToId}"]`);
                if (postElement) {
                    const commentCountSpan = postElement.querySelector('.comment-count');
                    let currentCount = parseInt(commentCountSpan.textContent);
                    commentCountSpan.textContent = currentCount + 1;
                }
            }
        }
        
        // --- CHAT NOTIFICATION LOGIC ---
        function updateChatNotificationBadge(count) {
            if (count && count > 0) {
                chatNotificationCount.textContent = count;
                chatNotificationCount.style.display = 'inline';
            } else {
                chatNotificationCount.textContent = '';
                chatNotificationCount.style.display = 'none';
            }
        }

        async function fetchUnreadChatCount() {
            if (!currentUserId) return 0;

            const { data: conversations } = await supabaseClient
                .from('conversations')
                .select('id')
                .or(`user1_id.eq.${currentUserId},user2_id.eq.${currentUserId}`);
                
            if (!conversations || conversations.length === 0) return 0;
            
            const conversationIds = conversations.map(c => c.id);

            const { count, error } = await supabaseClient
                .from('chat_messages')
                .select('id', { count: 'exact', head: true })
                .in('conversation_id', conversationIds)
                .neq('sender_id', currentUserId)
                .eq('is_read', false);

            if (error) {
                console.error("Error fetching unread chat count:", error);
                return 0;
            }

            updateChatNotificationBadge(count);
            return count;
        }


        
        // --- NOTIFICATION LOGIC ---

        async function fetchUnreadNotificationCount() {
            if (!currentUserId) return;
            
            const { count: generalCount, error: generalError } = await supabaseClient
                .from('notifications')
                .select('id', { count: 'exact', head: true })
                .eq('recipient_id', currentUserId)
                .eq('is_read', false);
                
            const unreadChatCount = await fetchUnreadChatCount();

            if (generalError) {
                console.error("Error fetching general notification count:", generalError);
                return;
            }
            
            const totalUnread = (generalCount || 0) + unreadChatCount;
            updateNotificationBadge(totalUnread);
        }
        
        function updateNotificationBadge(count) {
            if (count && count > 0) {
                notificationCount.textContent = count;
                notificationCount.style.display = 'inline';
            } else {
                notificationCount.textContent = '';
                notificationCount.style.display = 'none';
            }
        }

        async function renderNotifications() {
            notificationsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading...</p>';
            
            const { data: notifs, error } = await supabaseClient
                .from('notifications')
                .select(`
                    id, type, created_at, is_read, message_id,
                    sender:users!notifications_sender_id_fkey(username) 
                `)
                .eq('recipient_id', currentUserId)
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) {
                notificationsList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                return;
            }

            const unreadChatCount = await fetchUnreadChatCount();
            let chatNotifs = [];

            if (unreadChatCount > 0) {
                 chatNotifs = [{ 
                    id: 'chat-summary-temp', 
                    type: 'chat', 
                    created_at: new Date().toISOString(), 
                    is_read: false, 
                    sender: { username: 'System' }, 
                    message_id: null,
                    message: { content: `${unreadChatCount} unread chat message(s). Click to view.` } 
                 }];
            }
            
            const combinedNotifs = [...chatNotifs, ...notifs];

            if (combinedNotifs.length === 0) {
                notificationsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No new notifications.</p>';
                return;
            }
            
            let html = '';
            combinedNotifs.forEach(n => {
                const senderName = n.type === 'chat' ? 'Chat' : (n.sender ? `@${n.sender.username}` : 'A user');
                let iconClass;
                let text;
                let targetLink = '#';

                switch(n.type) {
                    case 'like':
                        iconClass = 'fas fa-heart';
                        text = `${senderName} liked your post.`;
                        targetLink = `feed.html#post-${n.message_id}`;
                        break;
                    case 'comment':
                        iconClass = 'fas fa-comment-dots';
                        text = `${senderName} commented on your post.`;
                        targetLink = `feed.html#post-${n.message_id}`;
                        break;
                    case 'chat':
                        iconClass = 'fas fa-comment-alt';
                        text = `${senderName}: ${n.message ? n.message.content : 'New messages.'}`;
                        targetLink = 'chat.html'; 
                        break;
                    default:
                        iconClass = 'fas fa-info-circle';
                        text = `${senderName} performed an action.`;
                }

                html += `
                    <a href="${targetLink}" class="notification-item ${n.is_read ? '' : 'unread'}" data-notif-id="${n.id}" data-type="${n.type}" style="text-decoration: none;">
                        <i class="${iconClass}"></i>
                        <span class="notification-text">${text}</span>
                        <span class="notification-time">${timeAgo(n.created_at)}</span>
                    </a>
                `;
            });
            notificationsList.innerHTML = html;
        }

        async function markAllNotificationsAsRead() {
            if (!currentUserId) return;
            
            const { error } = await supabaseClient
                .from('notifications')
                .update({ is_read: true })
                .eq('recipient_id', currentUserId)
                .eq('is_read', false);

            if (error) {
                alert("Failed to mark all as read.");
                console.error("Mark read error:", error);
            } else {
                updateNotificationBadge(0);
                updateChatNotificationBadge(0);
                renderNotifications(); 
            }
        }

        function toggleNotificationModal() {
            if (!currentUserId) { alert("You must be logged in to view notifications."); return; }
            
            if (notificationModal.style.display === 'flex') {
                notificationModal.style.display = 'none';
                document.body.style.overflow = 'auto'; 
            } else {
                renderNotifications(); 
                notificationModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; 
            }
        }
        
        // --- LOGOUT HANDLER ---
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = REDIRECT_PAGE;
        }

        // =================================================================================
        // --- PWA LOGIC START ---
        // =================================================================================
        function isiOS() {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }
        
        function isInStandaloneMode() {
            return ('standalone' in window.navigator) && (window.navigator.standalone);
        }
        
        // 1. Register the service worker for PWA
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker
              .register('/sw.js')
              .then(() => {
                console.log('Service Worker registered');
              })
              .catch(err => {
                console.error('SW registration failed', err);
              });
          });
        }

        // 2. PWA install prompt logic for Android/Desktop
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();       
          deferredPrompt = e;
          
          if (!isiOS() && !isInStandaloneMode()) {
            androidPromptOverlay.style.display = 'flex';
          }
        });

        pwaInstallButton.addEventListener('click', async () => {
          if (!deferredPrompt) {
            console.warn('Prompt is not available.');
            return; 
          }
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
          androidPromptOverlay.style.display = 'none';
        });
        
        window.addEventListener('appinstalled', () => {
            androidPromptOverlay.style.display = 'none';
        });

        // 3. iOS Home Screen Prompt Logic
        window.addEventListener('load', () => {
            if (isiOS() && !isInStandaloneMode()) {
                setTimeout(() => {
                    if (androidPromptOverlay.style.display !== 'flex') {
                        iosPromptOverlay.style.display = 'flex';
                    }
                }, 3000); 
            }
        });
        // =================================================================================
        // --- PWA LOGIC END ---
        // =================================================================================

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Theme Initialization
            const savedTheme = localStorage.getItem('theme') || 'dark';
            updateThemeUI(savedTheme === 'dark'); 

            // 2. User Session Check and Data Fetch
            const user = await checkUserSession();
            if (user) {
                // Modified to use pagination logic (start at offset 0, initial load = true)
                fetchFeedPosts(0, true); 
                renderSuggestedUsers();
                fetchUnreadNotificationCount();
                fetchUnreadChatCount(); 
                
                // 3. Setup Realtime for Notifications (General & Chat)
                
                supabaseClient.channel('public:notifications')
                    .on(
                        'postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'notifications', filter: `recipient_id=eq.${currentUserId}` },
                        (payload) => {
                            fetchUnreadNotificationCount(); 
                        }
                    )
                    .subscribe();

                supabaseClient.channel('public:chat_messages')
                    .on(
                        'postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'chat_messages' },
                        async (payload) => {
                            if (payload.new.sender_id !== currentUserId) {
                                await fetchUnreadChatCount();
                                fetchUnreadNotificationCount();
                            }
                        }
                    )
                    .subscribe();
            }
            
            // 4. Attach Event Listeners
            postForm.addEventListener('submit', handlePostCreation);
            notificationBtn.addEventListener('click', toggleNotificationModal);
            commentForm.addEventListener('submit', handleCommentSubmission);
            markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);

            if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleMenu);
            if (menuLogoutLink) menuLogoutLink.addEventListener('click', handleLogout);
            
            if (refreshStoriesBtn) {
                refreshStoriesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.currentTarget.classList.add('spinning');
                    renderSuggestedUsers().then(() => {
                        e.currentTarget.classList.remove('spinning');
                    });
                });
            }
        });
// 1. Helper function (Matches your placement)
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// 2. Main logic
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("enableNotifications");

  if (!btn) {
    console.error("Button with ID 'enableNotifications' not found in HTML!");
    return;
  }

  btn.addEventListener("click", async () => {
    const publicVapidKey = 'BCsdeMpKPh58L1p16fhaZvmIwyQF9mgp1IRwO39bxSc6qtefudhOlSSgdk5sILLtgUsoEqbNu5NccmCjt_RBkU4';

    try {
      if (!("Notification" in window)) {
        alert("This browser does not support notifications");
        return;
      }

      let permission = Notification.permission;

      // 1. If we haven't asked yet, ask now
      if (permission === "default") {
        permission = await Notification.requestPermission();
      }
      
      // 2. If granted (either just now or previously)
      if (permission === "granted") {
        console.log("Permission is granted. Syncing with database...");
        
        // Use '/sw.js' if 'sw.js' gives a file not found error
        const registration = await navigator.serviceWorker.register('sw.js');
        await navigator.serviceWorker.ready;

        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
        });

        // Get user from Supabase Auth
        const { data: { user } } = await supabaseClient.auth.getUser();

        // 3. Save/Update in Database
        const { error } = await supabaseClient
          .from('push_subscriptions')
          .upsert({ 
            user_id: user ? user.id : null, 
            subscription_json: subscription.toJSON(),
            last_updated: new Date().toISOString()
          }, { onConflict: 'subscription_json' });

        if (error) throw error;
        
        alert("Device Synced! You are ready for notifications. ðŸŽ‰");
      } else {
        alert("Notifications are blocked in your settings.");
      }
    } catch (err) {
      console.error(err);
      alert("Sync Error: " + err.message);
    }
  });
});

    </script> 


</body></html>
