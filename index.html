<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "d0551ffa-5bef-44c4-a74f-0a586ef17795",
    });
  });
</script>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#303f9f"> <link rel="icon" href="/images/icons/icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dashboard">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f4f6fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 60px; /* To prevent news from overlaying the bottom menu */
    }

    .header {
      background-color: #303f9f;
      color: white;
      padding: 24px;
      width: 90%;
      text-align: center;
      animation: extendHeader 3s alternate;
      position: fixed; /* Make the header fixed */
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100; /* Ensure it stays on top */
      overflow: hidden;
      border-bottom-left-radius: 30px; /* Add a subtle curve */
      border-bottom-right-radius: 30px; /* Add a subtle curve */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Optional shadow for better separation */
    }

    .header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .header h2 {
      margin: 5px 0 0;
      font-size: 1.8rem;
    }

    .header .user-level {
      color: #fdd835;
      font-size: 0.9rem;
      margin-top: 2px;
    }

    @keyframes extendHeader {
      0% { transform: translateX(-50%) scaleX(1); }
      50% { transform: translateX(-50%) scaleX(1.05); }
      100% { transform: translateX(-50%) scaleX(1); }
    }

    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 30px;
      background-color: #303f9f;
      clip-path: url(#wave);
    }

    .container {
      width: 90%;
      max-width: 800px;
      margin-top: 100px; /* Adjust margin to accommodate fixed header */
      margin-bottom: 80px;
    }

    .quick-start {
      background-color: #dbeafe;
      color: #1e3a8a;
      padding: 20px;
      text-align: center;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      cursor: pointer; /* Make it clickable */
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }

    .module-card {
      position: relative; /* IMPORTANT for badge positioning */
      background-color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
      cursor: pointer; /* Make it clickable */
    }
    
    .module-card:hover {
      transform: translateY(-3px);
    }

    .module-card i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #ff8f00; /* Dark orange color */
      display: block;
      -webkit-text-stroke: 1px #ff8f00; /* Outline for webkit browsers */
      text-stroke: 1px #ff8f00; /* Standard outline property */
      -webkit-font-smoothing: antialiased; /* Improve font rendering */
    }

    .module-card h3 {
      margin-top: 0;
      color: #1e3a8a;
      font-size: 1.1rem;
    }

    .module-card p {
      color: #6b7280;
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 10px 0 0;
    }

    /* Product Carousel styling */
    .news-carousel {
      position: relative;
      height: 200px;
      margin: 30px 0;
      overflow: hidden;
    }

    .news-slide {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      display: flex;
      gap: 15px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 10px;
      align-items: center;
      cursor: pointer; /* Make the entire slide clickable */
    }

    .news-slide.active {
      opacity: 1;
      z-index: 1;
    }

    .news-slide img {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
    }

    .news-slide div {
      flex: 1;
    }

    .news-slide h4 {
      margin: 0 0 5px;
      font-size: 1rem;
      color: #1e3a8a;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis; /* Truncate long product names */
    }

    .news-slide p {
      margin: 0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    /* NEW: Styling for the News Carousel Slides */
    #newsCarousel {
        height: 150px; /* Specific height for news carousel */
        margin-bottom: 30px;
    }
    #newsCarousel .news-slide {
        height: 100%; /* Fill the carousel height */
        align-items: flex-start; /* Align content to the top */
        padding: 15px;
    }

    #newsCarousel .news-slide img {
        width: 100px; /* Bigger image */
        height: 100px;
        flex-shrink: 0; /* Don't allow image to shrink */
    }

    #newsCarousel .news-slide div {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    #newsCarousel .news-slide h4 {
        font-size: 1.1rem;
        color: #ff8f00; /* Use orange accent for news title */
        white-space: normal; /* Allow title to wrap */
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box; 
        -webkit-line-clamp: 2; /* Show max 2 lines of title */
        -webkit-box-orient: vertical;
        margin-bottom: 5px;
    }

    #newsCarousel .news-slide p {
        font-size: 0.8rem;
        margin-top: 5px;
        color: #4b5563;
        display: -webkit-box; 
        -webkit-line-clamp: 2; /* Show max 2 lines of content */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    /* END NEW NEWS STYLING */

    .bottom-navigation {
      background-color: #ffffff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      width: 100%;
      position: fixed; /* Make the bottom navigation fixed */
      bottom: 0;
      left: 0;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
      z-index: 100; /* Ensure it stays on top */
    }

    .bottom-navigation a {
      text-decoration: none;
      color: #4b5563;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative; /* Make it a positioning context for the badge */
    }

    .bottom-navigation i {
      font-size: 1.2rem;
      margin-bottom: 2px;
    }
    
    /* NEW: Badge Styling for the bottom menu */
    .menu-badge {
      position: absolute;
      top: 0px; /* Position it above the icon/text */
      right: 50%;
      transform: translateX(50%); /* Center it above the element */
      background-color: #dc3545; /* Red circle */
      color: white;
      border-radius: 50%; /* Makes it a circle */
      padding: 2px 5px; /* Smaller padding for menu */
      font-size: 0.6rem; /* Smaller font size */
      font-weight: bold;
      line-height: 1;
      min-width: 15px; /* Minimum size */
      text-align: center;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
    }
    
    /* ðŸ”¥ NEW: Styling for the badge on the main card - applies to all main card badges */
    #cardNewChatCount, #marketplaceCard .menu-badge, #cardNewNewsCount {
      top: -5px; 
      right: 25%;
      transform: translateX(50%);
    }

    /* Reused modal styles from signup-modal */
    .signup-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* Reused form styles from signup-form */
    .signup-form {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 90%;
      max-width: 400px; /* Limit width for modals */
    }

    .signup-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #374151;
      text-align: left; /* Align labels to left within the form */
    }

    .signup-form input,
    .signup-form select {
      width: calc(100% - 20px); /* Account for padding */
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .signup-form button {
      background-color: #303f9f;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin: 5px; /* Add margin for buttons */
      width: auto; /* Allow buttons to size naturally */
    }

    .signup-form button:hover {
      background-color: #283593;
    }

    /* Styles for the choice modals */
    .choice-modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 90%;
        max-width: 350px; /* Slightly smaller for choice modals */
    }
    .choice-modal-content h2 {
        color: #303f9f;
        margin-bottom: 20px;
    }
    .choice-modal-content button {
        background-color: #303f9f;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1rem;
        width: 100%; /* Make buttons full width */
        margin-bottom: 10px; /* Space between buttons */
        transition: background-color 0.2s;
    }
    .choice-modal-content button:hover {
        background-color: #283593;
    }
    .choice-modal-content button.cancel-btn {
        background-color: #6c757d; /* Grey for cancel */
    }
    .choice-modal-content button.cancel-btn:hover {
        background-color: #5a6268;
    }

    #welcomeMessage {
      overflow: hidden;
      white-space: nowrap;
      margin: 0 auto;
      letter-spacing: .05em;
      /* Initial state with blinking cursor */
      border-right: .15em solid orange;
      animation:
        typing 2s steps(20, end),
        blink-caret .75s step-end infinite;
    }

    #welcomeMessage.typing-complete {
      border-right: none; /* Remove blinking cursor */
    }

    @keyframes typing {
      from { width: 0 }
      to { width: 100% }
    }

    @keyframes blink-caret {
      from, to { border-color: transparent }
      50% { border-color: orange; }
    }
    
    /* âœ… PWA LOGIC START: Install Prompt CSS */
    .pwa-prompt-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000; /* Very high z-index to cover everything */
    }

    .pwa-prompt-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      text-align: center;
      width: 90%;
      max-width: 350px;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .pwa-prompt-content h2 {
        margin-top: 0;
        color: #303f9f;
        font-size: 1.5rem;
        margin-bottom: 20px;
    }

    .pwa-prompt-content p {
        font-size: 1rem;
        color: #4b5563;
        line-height: 1.4;
        margin-bottom: 15px;
    }

    .pwa-install-button {
      background-color: #4CAF50; /* Green for Android/Install */
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      width: 100%;
      margin-top: 15px;
      transition: background-color 0.2s;
    }

    .pwa-install-button:hover {
      background-color: #45a049;
    }

    .pwa-icon {
        font-size: 2.5rem;
        color: #ff8f00; /* Accent color */
        margin-bottom: 10px;
    }

    .ios-step {
        display: flex;
        align-items: center;
        text-align: left;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    .ios-step i {
        font-size: 1.5rem;
        margin-right: 10px;
        color: #303f9f;
    }
    /* âœ… PWA LOGIC END: Install Prompt CSS */
/* NEW: Notification Dropdown Styles */
#chatNotification {
  position: fixed;
  top: -100px; /* Start off-screen */
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 350px;
  background-color: #001702e2; 
  color: white;
  border-bottom-left-radius: 10px;
  border-bottom-right-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  padding: 15px 20px;
  z-index: 2000; /* High z-index to be on top of everything */
  transition: top 0.4s ease-out; /* Smooth slide-in transition */
  cursor: pointer;
}

#chatNotification.show {
  top: 0px; /* Slide down below the fixed header */
}

.notification-content {
  display: flex;
  align-items: center;
  font-weight: bold;
}

.notification-content i {
  font-size: 1.5rem;
  margin-right: 15px;
}

#notificationText {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

  </style>
</head>
<body>

  <div class="header">

    <h1>Welcome</h1>
    <h2 id="welcomeMessage">Welcome User</h2>
    <p id="userLevel" class="user-level"></p>
    <svg class="wave" viewBox="0 24 150 40" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-120 47c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 30 v44h-352z" />
      </defs>
      <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.7)" />
      <use xlink:href="#gentle-wave" x="48" y="8" fill="rgba(255,255,255,0.7)" />
      <use xlink:href="#gentle-wave" x="4" y="25" fill="white" />
    </svg>
  </div><br><br><br>
  <div class="container">
    <div class="quick-start" onclick="window.location.href='exam.html'">Quick Start Exam</div>

    <div class="grid-container">
      <div class="module-card" onclick="openAcademicsChoiceModal()">
        <i class="fas fa-book-open"></i>
        <h3>Academics</h3>
        <p>Past Questions, Mock Exam, Profile, FAQ</p>
      </div>
      <div class="module-card" onclick="openCommunityChoiceModal()">
        <i class="fas fa-users"></i>
        <h3>Community</h3>
        <p>Chat, Clubs, Lost & Found</p>
        <span id="cardNewChatCount" class="menu-badge" style="display:none; top: -5px; right: 25%;">0</span> 
      </div>
      <div class="module-card" onclick="window.location.href='news.html'">
        <i class="fas fa-info-circle"></i>
        <h3>Information</h3>
        <p>News, Directory, Multilingual</p>
        <span id="cardNewNewsCount" class="menu-badge" style="display:none; top: -5px; right: 25%;">0</span> 
      </div>
      
      <div class="module-card" id="marketplaceCard" onclick="handleMarketplaceClick(event)">
        <i class="fas fa-shopping-cart"></i>
        <h3>Marketplace</h3>
        <p>Buy & Sell, Listings</p>
      </div>
    </div>
    <div id="chatNotification" style="display: none;"> 
  <div class="notification-content">
  <small>  <i class="fas fa-message" style="color:teal;"></i></small>
    <div id="notificationText"></div>
  </div>
</div>

    <div class="news-carousel" id="productCarousel">
    </div>
    
    <h2 id="latestNewsTitle" style="color: #303f9f; margin-top: -91px; border-bottom: 2px solid #303f9f; padding-bottom: 5px;">Latest News</h2>
    
    <div class="news-carousel" id="newsCarousel" style="height: 150px; margin-bottom: 30px;">
        <p id="newsLoadingMessage" style="text-align: center; line-height: 150px; color: #6b7280;">Loading latest news...</p>
    </div>
    <div id="signupModal" class="signup-modal">
      <div class="signup-form">
        <h2>Welcome! Please sign up</h2>
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="profileFaculty">Faculty:</label>
        <select id="profileFaculty" name="faculty" required>
          <option value="" disabled selected>Select Faculty</option>
        </select>

        <label for="profileCourse">Department/Course of Study:</label>
        <select id="profileCourse" name="department" required>
          <option value="" disabled selected>Select Department/Course</option>
        </select>

        <label for="level">Level:</label>
        <select id="level" name="level" required>
          <option value="">Select Level</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="300">300</option>
          <option value="400">400</option>
          <option value="500">500</option>
        </select>

        <button onclick="handleSignup()">Sign Up</button>
      </div>
    </div>

    <div id="examSelectionModal" class="signup-modal">
        <div class="signup-form">
            <h2>Select Your Mock Exam</h2>
            <label for="examFaculty">Faculty:</label>
            <select id="examFaculty" required>
              <option value="" disabled selected>Select Faculty</option>
            </select>

            <label for="examDepartment">Department:</label>
            <select id="examDepartment" required>
              <option value="" disabled selected>Select Department/Course</option>
            </select>

            <label for="examLevel">Level:</label>
            <select id="examLevel" required>
              <option value="">Select Level</option>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="300">300</option>
              <option value="400">400</option>
              <option value="500">500</option>
            </select>

            <label for="examCourseCode">Course Code (Optional):</label>
            <input type="text" id="examCourseCode" placeholder="e.g., ZOO 311">

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button onclick="closeExamSelectionModal()" style="background-color: #dc3545;">Cancel</button>
                <button onclick="startMockExam()">Start Exam</button>
            </div>
        </div>
    </div>

    <div id="academicsChoiceModal" class="signup-modal">
        <div class="choice-modal-content">
            <h2>Academics Options</h2>
            <button onclick="window.location.href='pdf.html'">Past Questions (PDF)</button>
          <a href="exam.html"><button>Mock Exam (CBE)</button></a>
            <button class="cancel-btn" onclick="closeAcademicsChoiceModal()">Cancel</button>
        </div>
    </div>

    <div id="communityChoiceModal" class="signup-modal">
        <div class="choice-modal-content">
            <h2>Community Options</h2>
            <button onclick="updateLastReadTime(); window.location.href='chat.html'">Chat</button> 
            <button onclick="alert('Clubs page coming soon!')">Clubs <font style="font-size:10px;">(coming soon)</button>
            <button onclick="alert('Lost & Found page coming soon!')">Lost & Found <font style="font-size:10px;">(coming soon)</font></button>
            <button onclick="window.location='groups.html';">Eksu Groups</button>

            
            
            <button class="cancel-btn" onclick="closeCommunityChoiceModal()">Cancel</button>
        </div>
    </div>
    
    <div id="android-prompt-overlay" class="pwa-prompt-overlay" style="display:none;">
      <div class="pwa-prompt-content">
        <i class="fab fa-android pwa-icon"></i>
        <h2>Install App</h2>
        <p>Install the app for a faster, full-screen experience!</p>
        <button id="pwa-install-button" class="pwa-install-button">
            <i class="fas fa-download"></i> Install App
        </button>
      </div>
    </div>

    <div id="ios-prompt-overlay" class="pwa-prompt-overlay" style="display:none;">
        <div class="pwa-prompt-content">
            <i class="fab fa-apple pwa-icon"></i>
            <h2>Add to Home Screen</h2>
            <p>Follow these quick steps to install on your iPhone/iPad:</p>
            <div class="ios-step">
                <i class="fa-solid fa-arrow-up-from-bracket"></i>
                <span>Tap the **Share** button at the bottom of the screen.</span>
            </div>
            <div class="ios-step">
                <i class="fa-solid fa-plus-square"></i>
                <span>Scroll down and tap **Add to Home Screen**.</span>
            </div>
            <button class="pwa-install-button" style="background-color: #6c757d;" onclick="document.getElementById('ios-prompt-overlay').style.display='none'">
                Got It
            </button>
        </div>
    </div>
    </div>

  <div class="bottom-navigation">
    <a href="#"><i class="fas fa-home"></i>Home</a>
    <a href="chat.html" onclick="updateLastReadTime()">
      <i class="fas fa-comments"></i>
      Chat
      <span id="menuNewChatCount" class="menu-badge" style="display:none;">0</span>
    </a>
    
    <a href="news.html" onclick="updateLastReadNewsTime()">
      <i class="fas fa-newspaper"></i>
      News
      <span id="menuNewNewsCount" class="menu-badge" style="display:none;">0</span> </a>
    
    <a href="market.html" onclick="handleMarketplaceClick(event)">
      <i class="fas fa-store"></i>
      Market
      <span id="menuNewProductCount" class="menu-badge" style="display:none;">0</span>
    </a>
    
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>
<div class='onesignal-customlink-container'></div>

  <script>
    // =================================================================================
    // --- SUPABASE CONFIGURATION ---
    // The marketplace keys you provided previously
    const MARKET_SUPABASE_URL = 'https://dyrsbfrvonajerbfrxzw.supabase.co'; 
    const MARKET_SUPABASE_AUTH_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5cnNiZnJ2b25hamVyYmZyeHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDk0ODAsImV4cCI6MjA3NTMyNTQ4MH0.mgj9f_ROkti_I3CeJ4ebYVhaLGy9Wamvj4XTtH_rB_I';
    
    // The chat keys you provided in the request
    const CHAT_SUPABASE_URL = 'https://bsifoxmtxrinthdjtvkq.supabase.co'; 
    const CHAT_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzaWZveG10eHJpbnRoZGp0dmtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDA3NDMsImV4cCI6MjA3NTQ3Njc0M30.pRnPe4FK3RQRSC30xYFuEtBEyacs7EuXdQ1DDpFJbOo'; 

    // Create a client for the market/news operations
    const marketSupabase = window.supabase.createClient(MARKET_SUPABASE_URL, MARKET_SUPABASE_AUTH_KEY);
    const PRODUCTS_TABLE = 'products';
    const ARTICLES_TABLE = 'articles';

    // Chat client (using standard initialization for polling)
    const chatSupabase = window.supabase.createClient(CHAT_SUPABASE_URL, CHAT_SUPABASE_ANON_KEY);
    const MESSAGES_TABLE = 'messages'; 
    // =================================================================================


    const productCarousel = document.getElementById('productCarousel');
    const newsCarousel = document.getElementById('newsCarousel');
    let slides = [];
    let current = 0;
    let newsSlides = [];
    let currentNews = 0;
    
    // NEW DOM elements for chat
    const chatNotification = document.getElementById('chatNotification');
    const notificationText = document.getElementById('notificationText');
    const chatBadgeMenu = document.getElementById('menuNewChatCount'); 
    const chatBadgeCard = document.getElementById('cardNewChatCount'); 

    // NEW Chat variables
    let newChatCount = 0; // Tracks the current number displayed on the badge
    let notificationTimeout = null;
    let chatPollingInterval = null; // The interval ID for the 5-second polling


    function showSlide(index) {
      slides.forEach((slide, i) => {
        slide.classList.remove('active');
        if (i === index) slide.classList.add('active');
      });
    }
    
    // --- Product Fetch and Carousel Initialization (MODIFIED FOR RANDOM ORDER) ---
    async function fetchAndRenderProducts() {
        try {
            // Fetch up to 5 products.
            const { data, error } = await marketSupabase
                .from(PRODUCTS_TABLE)
                .select('name, price, image_url, id')
                .order('id', { ascending: false }) 
                .limit(5);

            if (error) throw error;
            
            // Client-side shuffle for a random display of the fetched 5 most recent products
            data.sort(() => Math.random() - 0.5);

            productCarousel.innerHTML = ''; // Clear existing content
            
            data.forEach((product, index) => {
                const slide = document.createElement('div');
                slide.className = 'news-slide';
                if (index === 0) {
                    slide.classList.add('active'); // Activate the first slide
                }
                
                // Construct the HTML for the product slide
                slide.innerHTML = `
                    <img src="${product.image_url || 'placeholder.jpg'}" alt="${product.name}">
                    <div>
                        <h4>${product.name}</h4>
                        <p>â‚¦${(product.price || 0).toLocaleString()} <span style="color:#283593; font-weight:bold; font-size:0.75rem;"></span></p>
                    </div>
                `;
                slide.onclick = (e) => { 
                    // Use handleMarketplaceClick for consistent behavior and badge removal
                    handleMarketplaceClick(e); 
                    // Redirect to the specific product page after a short delay (for UX consistency with the async update)
                    setTimeout(() => {
                        window.location.href = 'market.html?product_id=' + product.id; 
                    }, 50);
                };

                productCarousel.appendChild(slide);
            });
            
            // Set up the carousel cycling
            slides = document.querySelectorAll('#productCarousel .news-slide');
            if (slides.length > 1) {
                if (window._carouselIntervalId) clearInterval(window._carouselIntervalId);
                window._carouselIntervalId = setInterval(() => {
                    current = (current + 1) % slides.length;
                    showSlide(current);
                }, 4000);
            }

        } catch (e) {
            console.error('Could not fetch products for carousel:', e);
            productCarousel.innerHTML = '<div style="padding:15px; text-align:center; color:#dc3545;">Could not load recent products.</div>';
        }
    }
    // --- End Product Carousel Logic ---

    // --- News Fetch and Carousel Initialization (Original) ---
    async function fetchAndRenderNews() {
        const newsLoadingMessage = document.getElementById('newsLoadingMessage');
        try {
            // Fetch up to 3 most recent articles, ordered by creation time
            const { data, error } = await marketSupabase
                .from(ARTICLES_TABLE)
                .select('id, title, content, image_url, created_at')
                .order('created_at', { ascending: false })
                .limit(3);

            if (error) throw error;
            
            newsLoadingMessage.style.display = 'none'; // Hide loading message
            newsCarousel.innerHTML = ''; // Clear existing content
            
            data.forEach((article, index) => {
                const slide = document.createElement('div');
                slide.className = 'news-slide';
                if (index === 0) {
                    slide.classList.add('active'); // Activate the first slide
                }
                
                // Get a short content snippet (first 100 chars)
                const snippet = article.content.substring(0, 100) + (article.content.length > 100 ? '...' : '');

                // Construct the HTML for the news slide
                slide.innerHTML = `
                    <img src="${article.image_url || 'https://via.placeholder.com/100x100?text=EKSU+News'}" alt="${article.title}">
                    <div>
                        <h4>${article.title}</h4>
                        <p>${snippet}</p>
                        <p style="font-size:0.7rem; color:#999; margin-top:5px;">${new Date(article.created_at).toLocaleDateString()}</p>
                    </div>
                `;
                slide.onclick = () => { 
                    // Update the last read time, then redirect
                    updateLastReadNewsTime();
                    window.location.href = `news.html?id=${article.id}`; 
                };

                newsCarousel.appendChild(slide);
            });
            
            // Set up the news carousel cycling
            newsSlides = document.querySelectorAll('#newsCarousel .news-slide');
            if (newsSlides.length > 1) {
                if (window._newsCarouselIntervalId) clearInterval(window._newsCarouselIntervalId);
                window._newsCarouselIntervalId = setInterval(() => {
                    currentNews = (currentNews + 1) % newsSlides.length;
                    // Reusing the existing showSlide logic for newsSlides
                    newsSlides.forEach((slide, i) => {
                        slide.classList.remove('active');
                        if (i === currentNews) slide.classList.add('active');
                    });
                }, 5000); // Cycle news every 5 seconds
            }

        } catch (e) {
            console.error('Could not fetch news for carousel:', e);
            newsLoadingMessage.style.display = 'none';
            newsCarousel.innerHTML = '<div style="padding:15px; text-align:center; color:#dc3545;">Could not load recent news.</div>';
        }
    }
    // --- End News Carousel Logic ---

    const signupModal = document.getElementById('signupModal');
    const welcomeMessageElement = document.getElementById('welcomeMessage');
    const userLevelDisplay = document.getElementById('userLevel');

    const nameInput = document.getElementById('name');
    const profileFacultySelect = document.getElementById('profileFaculty');
    const profileCourseSelect = document.getElementById('profileCourse');
    const levelSelect = document.getElementById('level');

    // --- NEW for Exam Selection Modal ---
    const examSelectionModal = document.getElementById('examSelectionModal');
    const examFacultySelect = document.getElementById('examFaculty');
    const examDepartmentSelect = document.getElementById('examDepartment');
    const examLevelSelect = document.getElementById('examLevel');
    const examCourseCodeInput = document.getElementById('examCourseCode');

    // --- NEW for Academics and Community Choice Modals ---
    const academicsChoiceModal = document.getElementById('academicsChoiceModal');
    const communityChoiceModal = document.getElementById('communityChoiceModal');
    
    // âœ… PWA LOGIC START: Get PWA elements
    const pwaInstallButton = document.getElementById("pwa-install-button");
    const androidPromptOverlay = document.getElementById('android-prompt-overlay');
    const iosPromptOverlay = document.getElementById('ios-prompt-overlay');
    let deferredPrompt;
    // âœ… PWA LOGIC END: Get PWA elements


    // --- EKSU Courses Data (Kept intact) ---
    const eksuCourses = {
        "Agriculture": [
            "Agricultural Economics and Extension Services",
            "Animal Production & Health Sciences",
            "Crop, Horticulture and Landscape Design",
            "Fisheries and Aquaculture Management",
            "Food Science and Technology",
            "Forestry Resources and Wildlife Management",
            "Soil Resources and Environmental Management"
        ],
        "Arts": [
            "English and Literary Studies",
            "French",
            "History and International Studies",
            "Linguistics and Nigerian Languages",
            "Philosophy",
            "Religious Studies",
            "Theatre and Media Arts",
            "Yoruba"
        ],
        "Education": [
            "Adult Education",
            "Business Education",
            "Educational Management",
            "Guidance and Counselling",
            "Human Kinetics and Health Education",
            "Library and Information Science",
            "Science Education (Biology, Chemistry, Maths, Physics, Computer Science)",
            "Social Science Education (Economics, Geography, Political Science)",
            "Vocational and Technical Education"
        ],
        "Engineering": [
            "Civil Engineering",
            "Computer Engineering",
            "Electrical/Electronic Engineering",
            "Mechanical Engineering"
        ],
        "Law": [
            "Law"
        ],
        "Management Sciences": [
            "Accounting",
            "Actuarial Science",
            "Banking and Finance",
            "Business Administration",
            "Cooperative Studies",
            "Entrepreneurship",
            "Industrial Relations and Personnel Management",
            "Insurance",
            "Marketing",
            "Public Administration"
        ],
        "Medicine/BMS": [
            "Anatomy",
            "Medicine and Surgery",
            "Nursing",
            "Physiology",
            "MLS"
        ],
        "Science": [
            "Biochemistry",
            "Biology",
            "Biotechnology",
            "Chemistry",
            "Computer Science",
            "Geology",
            "Geophysics",
            "Industrial Chemistry",
            "Mathematics",
            "Microbiology",
            "Physics",
            "Plant Sciences",
            "Science Laboratory Technology",
            "Statistics",
            "Zoology"
        ],
        "Social Sciences": [
            "Economics",
            "Environmental Management",
            "Geography and Planning Science",
            "Intelligence and Security Studies",
            "International Relations",
            "Mass Communication",
            "Peace and Conflict Resolution",
            "Political Science",
            "Psychology",
            "Social Work",
            "Sociology",
            "Tourism Studies"
        ]
    };

    // --- Functions for Profile Setup Dropdowns (Original) ---
    function populateFaculties() {
        profileFacultySelect.innerHTML = '<option value="" disabled selected>Select Faculty</option>';
        for (const faculty in eksuCourses) {
            const option = document.createElement('option');
            option.value = faculty;
            option.textContent = faculty;
            profileFacultySelect.appendChild(option);
        }
    }

    function populateCourses() {
        const selectedFaculty = profileFacultySelect.value;
        profileCourseSelect.innerHTML = '<option value="" disabled selected>Select Department/Course</option>';

        if (selectedFaculty && eksuCourses[selectedFaculty]) {
            eksuCourses[selectedFaculty].forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                profileCourseSelect.appendChild(option);
            });
        }
    }
    profileFacultySelect.addEventListener('change', populateCourses);


    // --- Functions for Exam Selection Modal Dropdowns (Original) ---
    function populateExamFaculties() {
        examFacultySelect.innerHTML = '<option value="" disabled selected>Select Faculty</option>';
        for (const faculty in eksuCourses) {
            const option = document.createElement('option');
            option.value = faculty;
            option.textContent = faculty;
            examFacultySelect.appendChild(option);
        }
    }

    function populateExamDepartments() {
        const selectedFaculty = examFacultySelect.value;
        examDepartmentSelect.innerHTML = '<option value="" disabled selected>Select Department/Course</option>';

        if (selectedFaculty && eksuCourses[selectedFaculty]) {
            eksuCourses[selectedFaculty].forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                examDepartmentSelect.appendChild(option);
            });
        }
    }
    examFacultySelect.addEventListener('change', populateExamDepartments);


    // --- Core Signup/Profile Logic (Original) ---
    const storedSignedUp = localStorage.getItem('signedUp');
    const storedName = localStorage.getItem('name');
    const storedLevel = localStorage.getItem('level');


    function typeWelcomeMessage(name) {
      welcomeMessageElement.textContent = "";
      let i = 0;
      if (welcomeMessageElement._typingIntervalId) {
        clearInterval(welcomeMessageElement._typingIntervalId);
      }
      welcomeMessageElement.classList.remove('typing-complete');

      welcomeMessageElement._typingIntervalId = setInterval(() => {
        welcomeMessageElement.textContent += name[i];
        i++;
        if (i === name.length) {
          clearInterval(welcomeMessageElement._typingIntervalId);
          welcomeMessageElement.classList.add('typing-complete');
        }
      }, 100);
    }

    // --- MARKETPLACE TRACKING FUNCTIONS (Original) ---
    
    // This function runs on page load to check for new products
    async function checkNewProducts() {
        let newProducts = 0; // Initialize a variable to hold the new product count
        const lastCount = parseInt(localStorage.getItem('lastMarketProductCount') || '0');
        const countElement = document.getElementById('menuNewProductCount'); 
        
        try {
            // Get the current total count of products in the table
            const { count, error } = await marketSupabase
                .from(PRODUCTS_TABLE)
                .select('*', { count: 'exact', head: true });

            if (error) throw error;

            const currentCount = count;
            
            if (currentCount > lastCount) {
                newProducts = currentCount - lastCount; // Set the new product count
                countElement.textContent = newProducts;
                countElement.style.display = 'block';
                console.log(`New products detected: ${newProducts}`);
            } else {
                countElement.style.display = 'none';
            }
            
            // If it's the very first time loading and we have products, save the count
            if (lastCount === 0 && currentCount > 0) {
                 localStorage.setItem('lastMarketProductCount', currentCount.toString());
            }

        } catch (e) {
            console.error('Could not check product count:', e);
            countElement.style.display = 'none';
        }
        
        return newProducts; 
    }

    // This function runs when the user clicks the Marketplace card OR the menu link
    async function handleMarketplaceClick(event) {
        // Prevent default navigation for the menu link and the main card
        if (event && event.preventDefault) {
             event.preventDefault();
        }

        const countElement = document.getElementById('menuNewProductCount'); 
        
        try {
            // 1. Get the current count and save it as the 'last viewed' count
            const { count, error } = await marketSupabase
                .from(PRODUCTS_TABLE)
                .select('*', { count: 'exact', head: true });

            if (!error) {
                // Update localStorage with the new count immediately
                localStorage.setItem('lastMarketProductCount', count.toString());
                countElement.style.display = 'none'; // Hide the badge
            }
        } catch(e) {
            console.error("Error updating product count before redirect:", e);
            // Non-blocking: continue with redirect even on error
        }

        // 2. Redirect the user 
        window.location.href = 'market.html';
    }
    
    // =================================================================================
    // --- CHAT POLLING LOGIC (FIXED FOR 5-SECOND REFRESH) ---
    // =================================================================================

    /**
     * Displays a new chat message as a temporary dropdown notification.
     * @param {object} message - The new message payload from Supabase (must include 'username' and 'content').
     */
    function showDropdownNotification(message) {
        const sender = message.username || 'New User';
        const content = message.content || '...';
        
        if (window.location.pathname.includes('chat.html')) return;

        notificationText.innerHTML = `<strong>${sender}:</strong> ${content}`;

        // 1. Clear any existing timeout and hide the notification immediately
        clearTimeout(notificationTimeout);
        chatNotification.classList.remove('show');
        chatNotification.style.display = 'block';

        // 2. Schedule the slide-in (after a small delay to ensure transition works)
        setTimeout(() => {
            chatNotification.classList.add('show');
        }, 50); 
        
        // 3. Schedule the slide-out after 3 seconds (3000 milliseconds)
        notificationTimeout = setTimeout(() => {
            chatNotification.classList.remove('show');
            
            // 4. Wait for the CSS transition to finish (0.4s) before hiding display
            setTimeout(() => {
                chatNotification.style.display = 'none';
            }, 400); 

        }, 4000); // <-- 4-second display time

        // Make the notification clickable to go to the chat page
        chatNotification.onclick = () => {
            updateLastReadTime();
            clearTimeout(notificationTimeout);
            chatNotification.classList.remove('show');
            setTimeout(() => {
                window.location.href = 'chat.html';
            }, 400); // Allow slide-up transition before redirect
        };
    }

    /**
     * Fetches new messages and updates the badge count and triggers the notification dropdown.
     */
    async function pollForNewChatCount() {
        const lastReadTime = localStorage.getItem('last_read_chat_time');
        
        if (localStorage.getItem('signedUp') !== 'true') return;
        
        // If lastReadTime isn't set, initialize it and exit. This prevents fetching all history on first run.
        if (!lastReadTime) {
            localStorage.setItem('last_read_chat_time', Date.now().toString());
            return;
        }

        // If the user is on the chat page, clear local badges and exit.
        if (window.location.pathname.includes('chat.html')) {
            newChatCount = 0;
            chatBadgeMenu.style.display = 'none';
            chatBadgeCard.style.display = 'none';
            return;
        }
        
        const lastReadISO = new Date(parseInt(lastReadTime)).toISOString();
        
        try {
            // 1. Get the current total count of unread messages
            const { count: currentUnreadCount, error } = await chatSupabase
                .from(MESSAGES_TABLE)
                .select('*', { count: 'exact', head: true })
                .gt('created_at', lastReadISO);

            if (error) throw error;
            
            const oldChatCount = newChatCount;
            newChatCount = currentUnreadCount; // Update the global counter
            
            // 2. Calculate newly arrived messages since the last 5-second check
            const newlyArrivedMessages = newChatCount - oldChatCount;
            
            // 3. Update Badges
            if (newChatCount > 0) {
                chatBadgeMenu.textContent = newChatCount;
                chatBadgeMenu.style.display = 'block';
                chatBadgeCard.textContent = newChatCount;
                chatBadgeCard.style.display = 'block';
            } else {
                chatBadgeMenu.style.display = 'none';
                chatBadgeCard.style.display = 'none';
            }

            // 4. Trigger Dropdown Notification if there are new messages
            if (newlyArrivedMessages > 0) {
                // Fetch the actual message data for the notification
                const { data: latestMessages, error: dataError } = await chatSupabase
                    .from(MESSAGES_TABLE)
                    .select('username, content')
                    .gt('created_at', lastReadISO)
                    .order('created_at', { ascending: false })
                    .limit(newlyArrivedMessages);

                if (!dataError && latestMessages && latestMessages.length > 0) {
                    // Show a notification for the *latest* new message only
                    showDropdownNotification(latestMessages[0]);
                }
            }

        } catch (e) {
            console.error('Error during chat polling:', e);
            // Non-fatal: just skip this cycle
        }
    }

    /**
     * Sets up the 5-second interval for chat polling.
     */
    function startChatPolling() {
        if (chatPollingInterval) clearInterval(chatPollingInterval); // Clear any existing interval
        
        // Run the check immediately on start
        pollForNewChatCount(); 
        
        // Set up the interval for manual refresh every 5 seconds (5000 milliseconds)
        chatPollingInterval = setInterval(pollForNewChatCount, 5000); 
    }
    
    /**
     * Updates the last read timestamp and clears the badges.
     * This function is called when the user clicks the Chat link or button.
     */
    function updateLastReadTime() {
        if (localStorage.getItem('signedUp') === 'true') {
            newChatCount = 0;
            chatBadgeMenu.style.display = 'none';
            chatBadgeCard.style.display = 'none';
            localStorage.setItem('last_read_chat_time', Date.now().toString());
            console.log("Chat last read time updated.");
        }
    }
    
    // =================================================================================
    // --- END CHAT POLLING LOGIC ---
    // =================================================================================


    // --- NEWS TRACKING LOGIC (Original) ---
    async function checkNewNews() {
        const lastReadTime = localStorage.getItem('last_read_news_time');
        
        const newsBadgeMenu = document.getElementById('menuNewNewsCount'); 
        const newsBadgeCard = document.getElementById('cardNewNewsCount');
        
        if (!lastReadTime) {
            newsBadgeMenu.style.display = 'none';
            newsBadgeCard.style.display = 'none'; 
            
            if(localStorage.getItem('signedUp') === 'true') {
                localStorage.setItem('last_read_news_time', Date.now().toString());
            }
            return;
        }

        const lastReadISO = new Date(parseInt(lastReadTime)).toISOString();
        
        try {
            const { count, error } = await marketSupabase
                .from(ARTICLES_TABLE)
                .select('*', { count: 'exact', head: true })
                .gt('created_at', lastReadISO);

            if (error) throw error;
            
            const newArticles = count;
            
            if (newArticles > 0) {
                newsBadgeMenu.textContent = newArticles;
                newsBadgeMenu.style.display = 'block';
                
                newsBadgeCard.textContent = newArticles;
                newsBadgeCard.style.display = 'block'; 
            } else {
                newsBadgeMenu.style.display = 'none';
                newsBadgeCard.style.display = 'none'; 
            }

        } catch (e) {
            console.error('Could not check new news count:', e);
            newsBadgeMenu.style.display = 'none';
            newsBadgeCard.style.display = 'none';
        }
    }

    /**
     * Updates the last read timestamp and clears the news badge.
     */
    function updateLastReadNewsTime() {
        // 1. Set the new last read time to now.
        localStorage.setItem('last_read_news_time', Date.now().toString());

        // 2. Hide the badges immediately.
        document.getElementById('menuNewNewsCount').style.display = 'none';
        document.getElementById('cardNewNewsCount').style.display = 'none';
        
        // 3. Clear the interval that periodically checks for new news
        if (window._newsCheckInterval) {
            clearInterval(window._newsCheckInterval);
        }
    }

    // --- INITIALIZATION (Updated to use Polling) ---

    if (!storedSignedUp) {
      signupModal.style.display = 'flex';
      populateFaculties();
    } else {
      typeWelcomeMessage(storedName);
      userLevelDisplay.textContent = storedLevel ? `Level: ${storedLevel}` : '';
      
      // Feature Checks
      checkNewProducts(); 
      checkNewNews(); 
      
      // *** START 5-SECOND CHAT POLLING HERE ***
      startChatPolling(); 

      // Carousel Loads
      // NOTE: Ensure fetchAndRenderProducts and fetchAndRenderNews are defined elsewhere or included here.
      // (They are generally defined above this main initialization block.)
      // Placeholder calls, assuming definitions are available:
      // fetchAndRenderProducts(); 
      // fetchAndRenderNews();
      
      // Periodic Checks
      window._newsCheckInterval = setInterval(checkNewNews, 15000); 
    }

    function handleSignup() {
      const name = nameInput.value.trim();
      const faculty = profileFacultySelect.value;
      const department = profileCourseSelect.value;
      const level = levelSelect.value;

      if (!name) { alert('Please enter your name.'); return; }
      if (!faculty) { alert('Please select your Faculty.'); return; }
      if (!department) { alert('Please select your Department/Course of Study.'); return; }
      if (!level) { alert('Please select your Level.'); return; }

      localStorage.setItem('signedUp', 'true');
      localStorage.setItem('name', name);
      localStorage.setItem('faculty', faculty);
      localStorage.setItem('department', department);
      localStorage.setItem('level', level);
      
      // Initialize chat last read time on signup
      localStorage.setItem('last_read_chat_time', Date.now().toString());
      // Initialize news last read time on signup
      localStorage.setItem('last_read_news_time', Date.now().toString());

      signupModal.style.display = 'none';
      typeWelcomeMessage(name);
      userLevelDisplay.textContent = level ? `Level: ${level}` : '';
      alert('Sign up complete! Welcome!');
      
      // Run dashboard features after successful signup
      checkNewProducts();
      fetchAndRenderProducts();
      
      checkNewNews();
      fetchAndRenderNews();
      
      // *** START 5-SECOND CHAT POLLING HERE ***
      startChatPolling(); 
      
      // Periodic Checks
      window._newsCheckInterval = setInterval(checkNewNews, 15000); 
    }

    function reRegister() {
      localStorage.removeItem('signedUp');
      localStorage.removeItem('name');
      localStorage.removeItem('department');
      localStorage.removeItem('faculty');
      localStorage.removeItem('level');
      
      nameInput.value = '';
      profileFacultySelect.value = '';
      profileCourseSelect.innerHTML = '<option value="" disabled selected>Select Department/Course</option>';
      levelSelect.value = '';

      signupModal.style.display = 'flex';
      populateFaculties();
      welcomeMessageElement.textContent = 'Welcome User';
      userLevelDisplay.textContent = '';
      alert('You can re-register now. Please fill out the form.');
    }

    // --- Modal Control Functions (Original) ---
      
    // Academics Modal
    function openAcademicsChoiceModal() {
        academicsChoiceModal.style.display = 'flex';
    }

    function closeAcademicsChoiceModal() {
        academicsChoiceModal.style.display = 'none';
    }

    function openExamSelectionModalFromAcademics() {
        closeAcademicsChoiceModal(); // Close the academics choice modal first
        openExamSelectionModal(); // Then open the exam selection modal
    }

    // Exam Selection Modal
    function openExamSelectionModal() {
        examSelectionModal.style.display = 'flex';
        populateExamFaculties(); // Populate faculties when modal opens

        // Pre-fill with user's saved profile data
        const storedFaculty = localStorage.getItem('faculty');
        const storedDepartment = localStorage.getItem('department');
        const storedLevel = localStorage.getItem('level');

        if (storedFaculty) {
            examFacultySelect.value = storedFaculty;
            populateExamDepartments(); // Populate departments based on pre-filled faculty
            if (storedDepartment) {
                examDepartmentSelect.value = storedDepartment;
            }
        }
        if (storedLevel) {
            examLevelSelect.value = storedLevel;
        }
        examCourseCodeInput.value = ''; // Clear previous course code
    }

    function closeExamSelectionModal() {
        examSelectionModal.style.display = 'none';
    }

    function startMockExam() {
        const faculty = examFacultySelect.value;
        const department = examDepartmentSelect.value;
        const level = examLevelSelect.value;
        const courseCode = examCourseCodeInput.value.trim();

        if (!faculty) { alert("Please select a Faculty for the exam."); return; }
        if (!department) { alert("Please select a Department for the exam."); return; }
        if (!level) { alert("Please select a Level for the exam."); return; }

        let queryString = `?faculty=${encodeURIComponent(faculty)}&department=${encodeURIComponent(department)}&level=${encodeURIComponent(level)}`;
        if (courseCode) {
            queryString += `&courseCode=${encodeURIComponent(courseCode.toUpperCase())}`;
        }

        closeExamSelectionModal();
        window.location.href = 'exam.html' + queryString; // Redirect to exam.html (or cbe.html if you rename it)
    }

    // Community Modal
    function openCommunityChoiceModal() {
        communityChoiceModal.style.display = 'flex';
    }

    function closeCommunityChoiceModal() {
        communityChoiceModal.style.display = 'none';
    }
    
    // =================================================================================
    // âœ… PWA LOGIC START: Service Worker and Install Prompt Handling contact me 07077575301
    // =================================================================================

    // 1. Register the service worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then(() => {
            console.log('Service Worker registered');
          })
          .catch(err => {
            console.error('SW registration failed', err);
          });
      });
    }

    // 2. PWA install logic for Android/Desktop
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevents the default browser prompt
      e.preventDefault();       
      deferredPrompt = e;
      
      // Check if it's not iOS and not already installed (standalone mode)
      if (!isiOS() && !isInStandaloneMode()) {
        androidPromptOverlay.style.display = 'flex'; // Show your custom Android/Desktop prompt overlay
      }
      console.log('PWA Install prompt saved.');
    });

    pwaInstallButton.addEventListener('click', async () => {
      if (!deferredPrompt) {
        console.warn('Prompt is not available.');
        return; 
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response to the install prompt: ${outcome}`);
      deferredPrompt = null;
      androidPromptOverlay.style.display = 'none'; // Hide the prompt after user choice
    });
    
    window.addEventListener('appinstalled', () => {
        androidPromptOverlay.style.display = 'none'; // Ensure prompt is hidden if install succeeds
    });

    // 3. iOS Home Screen Prompt Logic
    function isiOS() {
        const userAgent = window.navigator.userAgent.toLowerCase();
        return /iphone|ipad|ipod/.test(userAgent);
    }
    
    function isInStandaloneMode() {
        // This checks if the app is already installed and opened from the home screen
        return ('standalone' in window.navigator) && (window.navigator.standalone);
    }

    window.addEventListener('load', () => {
        // Check if it's iOS and NOT in standalone mode
        if (isiOS() && !isInStandaloneMode()) {
            // Show the iOS-specific prompt after a short delay
            setTimeout(() => {
                // Ensure the Android prompt is not showing (for cross-platform browsers on iOS)
                if (androidPromptOverlay.style.display !== 'flex') {
                    iosPromptOverlay.style.display = 'flex';
                }
            }, 3000); // 3-second delay
        }
    });

    // =================================================================================
    // âœ… PWA LOGIC END/07077575301 Monpress, Wa or call
    // =================================================================================

    // --- RE-CALLING INITIALIZATION FUNCTIONS for final complete script ---
    // (This block ensures the missing function calls for products and news loading are included if they were omitted in previous steps)
    
    if (storedSignedUp) {
        // Assuming fetchAndRenderProducts and fetchAndRenderNews are defined (they are in the original code block)
        fetchAndRenderProducts(); 
        fetchAndRenderNews();
    }


  </script>
</body>
</html>
