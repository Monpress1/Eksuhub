<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EKSU MARKET | Campus Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ==================================== */
        /* --- Root Variables & Base Styling --- */
        /* ==================================== */
        :root {
            --primary-color: #1f3b7d; /* Deep Blue */
            --secondary-color: #e19d00; /* Gold/Yellow */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1); /* Updated for modern look */
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.15);
            --border-radius: 13px;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: #333; 
            line-height: 1.6;
            padding-bottom: 60px; /* Space for bottom nav */
        }
        
        /* ==================================== */
        /* --- Header & Navigation (Modern Curved) --- */
        /* ==================================== */
        .header { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: var(--shadow-medium);
            position: relative; /* Needed for z-index context */
            z-index: 10;
            height: 90px; /* Increased height for a deeper curve */
        }
        
        /* The clip-path is now applied here for the modern curved bottom */
        .header-curved-bottom {
            clip-path: path("M 0 0 L 100% 0 L 100% 100% C 75% 70%, 25% 120%, 0 100% Z");
        }

        .header-left, .header-right { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }

        .header h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            font-weight: 700;
        }

        .header .icon, .back-btn { 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: white;
            text-decoration: none; /* For back button link */
        }
        
        .list-btn { 
            background-color: var(--secondary-color); 
            color: var(--primary-color); 
            border: none; 
            padding: 8px 15px; 
            border-radius: 20px; /* More pill-shaped */
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: bold; 
            transition: background-color 0.3s; 
            box-shadow: var(--shadow-light);
        }
        .list-btn:hover { background-color: #e6c800; }

        /* ==================================== */
        /* --- Controls (Search & Filters) --- */
        /* ==================================== */
        .controls { 
            padding: 20px; 
            padding-top: 10px; /* Move controls up a bit */
            background: var(--bg-color); /* Matches body background */
            position: relative;
            z-index: 5;
        }
        
        /* Google Search Bar Style */
        .search-container { 
            display: flex; 
            align-items: center;
            border: none; /* Remove default border */
            border-radius: 30px; /* Pill shape */
            overflow: hidden; 
            width: 100%;
            background-color: var(--card-bg); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Elevated shadow */
            transition: box-shadow 0.3s;
        }
        .search-container:focus-within {
             box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); 
        }

        .search-input { 
            padding: 12px 15px; /* More padding */
            border: none; 
            flex-grow: 1; 
            font-size: 1rem; 
            background: transparent;
        }
        .search-icon { 
            color: var(--primary-color); /* Icon color */
            padding: 12px 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* Filter Row/Pills */
        .filter-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .filter-toggle-btn {
            display: block; /* Show on mobile */
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
        }

        .filter-pills-container {
            display: flex;
            gap: 10px;
            overflow-x: auto; /* Allows horizontal scrolling */
            padding-bottom: 5px; /* Space for scrollbar */
            white-space: nowrap; /* Keeps pills in one line */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .filter-pill {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px; /* Round pill shape */
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #e9ecef; /* Inactive/round background */
            color: #495057; /* Inactive color */
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .filter-pill:hover, .filter-pill.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        /* ==================================== */
        /* --- Product Grid & Pagination --- */
        /* ==================================== */
        .product-grid { 
            padding: 20px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        
        /* Card styles remain largely the same */
        .product-card { 
            background: var(--card-bg); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--shadow-medium); 
            transition: transform 0.3s, box-shadow 0.3s; 
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .product-card img { width: 100%; height: 180px; object-fit: cover; }
        .product-info { padding: 15px; }
        .product-info h2 { font-size: 1.2rem; margin-top: 0; margin-bottom: 5px; color: var(--primary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .product-price { font-size: 1.6rem; font-weight: 800; color: #d9534f; margin-bottom: 10px; display: block;}
        
        /* Tags */
        .tag-row { margin-bottom: 8px; }
        .product-tag { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 15px; 
            margin-right: 5px; 
            font-size: 0.7rem; 
            font-weight: bold; 
            text-transform: uppercase;
        }
        .tag-neg { background-color: #f0ad4e; color: white; }
        .tag-new { background-color: #5cb85c; color: white; }
        .tag-used { background-color: #007bff; color: white; }
        .tag-location { color: #6c757d; font-weight: 500; font-size: 0.85rem; margin-top: 5px; display: block;}
        
        /* ==================================== */
        /* --- NEW ACTION BUTTON STYLES --- */
        /* ==================================== */
        .action-btns {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn { 
            padding: 10px; 
            border-radius: var(--border-radius); 
            text-decoration: none; 
            display: block; 
            text-align: center; 
            font-weight: 600; 
            transition: background-color 0.2s, opacity 0.2s;
            flex-grow: 1; /* Allows buttons to share space */
            border: none;
            cursor: pointer;
            font-size: 0.9rem; /* Match list-btn size */
        }
        
        .whatsapp-btn { 
            background-color: #25d366; 
            color: white; 
        }
        .whatsapp-btn:hover { background-color: #128c7e; }

        .share-btn {
            background-color: var(--secondary-color); /* Gold color */
            color: var(--primary-color); 
        }
        .share-btn:hover {
             background-color: #e6c800;
        }
        /* ==================================== */


        #loading { text-align: center; padding: 50px; font-size: 1.2em; color: #6c757d; }
        
        /* Pagination Controls */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            margin-top: 20px;
        }
        .pagination button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .pagination button:hover:not(:disabled) {
            background-color: #152d61;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .pagination span {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ==================================== */
        /* --- Modal Styling (List Form) --- */
        /* ==================================== */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { 
            background-color: var(--card-bg); 
            margin: 5vh auto; 
            padding: 30px; 
            border-radius: var(--border-radius); 
            width: 90%; 
            max-width: 500px; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        
        /* Form fields inside modal */
        .form-row { margin-bottom: 15px; }
        .modal-content label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color); }
        .modal-content input[type="text"], .modal-content input[type="number"], 
        .modal-content textarea, .modal-content input[type="file"], .modal-content select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .checkbox-group { display: flex; align-items: center; margin-top: 10px; margin-bottom: 20px; }
        .checkbox-group input { width: 20px; height: 20px; margin-right: 10px; }
        
        .modal-content button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 5px;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .modal-content button[type="submit"]:hover {
            background-color: #152d61;
        }

        /* Bottom Navigation Bar */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 20;
            padding: 5px 0;
        }

        .bottom-navigation a {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.75rem;
            transition: color 0.3s;
        }

        .bottom-navigation a i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .bottom-navigation a:hover, .bottom-navigation a.active {
            color: var(--primary-color);
        }
        
        /* Media Query for larger screens */
        @media (min-width: 768px) {
            .header { padding: 15px 40px; }
            .header h1 { font-size: 2rem; }
            .controls { padding: 20px 40px; }
            .search-container { width: 450px; /* Limit search width on desktop */ }
            .filter-row { flex-wrap: nowrap; }
            .product-grid { padding: 40px; }
            .modal-content { margin: 10vh auto; }
            
            .filter-toggle-btn { display: none; } /* Hide filter icon on desktop */
            .filter-pills-container { overflow-x: visible; } /* No scrollbar needed */
        }
    </style>
</head>
<body>

    <div class="header header-curved-bottom">
        <div class="header-left">
             <a href="index.html" class="back-btn" aria-label="Go Back to Home">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>EKSU MARKET</h1>
        </div>
        <div class="header-right">
             <i class="fas fa-shopping-cart icon" aria-label="Shopping Cart"></i>
            <button class="list-btn" onclick="openSellModal()">SELL</button>
        </div>
    </div>

    <div class="controls">
        <div class="search-container">
            <div class="search-icon"><i class="fas fa-search"></i></div>
            <input type="text" id="searchInput" class="search-input" placeholder="Search product name, description, or location..." aria-label="Search">
            <button class="filter-toggle-btn" id="filterToggleBtn" aria-label="Toggle Filters"><i class="fas fa-sliders-h"></i></button>
        </div>

        <div class="filter-header">
            <div class="filter-pills-container" id="filterPillsContainer">
                <span class="filter-pill active" data-category="">All Categories</span>
                <span class="filter-pill" data-category="Gadgets">Gadgets</span>
                <span class="filter-pill" data-category="Clothes">Clothes</span>
                <span class="filter-pill" data-category="Foodstuff">Foodstuff</span>
                <span class="filter-pill" data-category="Books">Books</span>
                <span class="filter-pill" data-category="Services">Services</span>
                <span class="filter-pill" data-category="Other">Other</span>
            </div>
        </div>
    </div>

    <div id="message"></div>

    <div id="loading">Loading products...</div>
    <div class="product-grid" id="productGrid">
    </div>

    <div class="pagination" id="paginationControls">
        <button id="prevPageBtn" disabled>Previous</button>
        <span id="pageInfo">Page 1 of 1</span>
        <button id="nextPageBtn" disabled>Next</button>
    </div>

    <div id="sellProductModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeSellModal()" aria-label="Close Modal">&times;</span>
            <h2>List Your Item for Sale</h2>
            
            <form id="productForm">
                
                <div class="form-row">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" name="productName" required>
                </div>
                
                <div class="form-row">
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                        <option value="">-- Select Category --</option>
                        <option value="Gadgets">Gadgets</option>
                        <option value="Clothes">Clothes</option>
                        <option value="Foodstuff">Foodstuff</option>
                        <option value="Books">Books</option>
                        <option value="Services">Services</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="condition">Item Condition</label>
                    <select id="condition" name="condition" required>
                        <option value="">-- Select Condition --</option>
                        <option value="New">New</option>
                        <option value="Used but Neat">Used but Neat</option>
                        <option value="Used">Used</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="price">Price (₦)</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" required>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="isNegotiable" name="isNegotiable">
                    <label for="isNegotiable">Negotiable</label>
                </div>

                <div class="form-row">
                    <label for="imageFile">Product Main Image (Required - Max 1)</label>
                    <input type="file" id="imageFile" name="imageFile" accept="image/*" required>
                </div>
                
                <div class="form-row">
                    <label for="description">Product Description</label>
                    <textarea id="description" name="description" required></textarea>
                </div>

                <div class="form-row">
                    <label for="location">Location (e.g., Iworoko-Ekiti, Ado Ekiti)</label>
                    <input type="text" id="location" name="location" required>
                </div>
                
                <div class="form-row">
                    <label for="whatsappNumber">WhatsApp No</label>
                    <input type="text" id="whatsappNumber" name="whatsappNumber" placeholder="e.g., 080XXXXXXXX" required>
                </div>
                
                <button type="submit" id="submitButton">LIST PRODUCT</button>
            </form>
        </div>
    </div>
        
  <div class="bottom-navigation">
    <a href="index.html" class="active"><i class="fas fa-home"></i>Home</a>
    <a href="chat.html"><i class="fas fa-comments"></i>Chat</a>
    <a href="news.html"><i class="fas fa-newspaper"></i>News</a>
    <a href="market.html"><i class="fas fa-store"></i>Market</a>
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>
    <script>
        // =================================================================================
        // --- Supabase Configuration & Globals ---
        // =================================================================================
        // !!! IMPORTANT: REPLACE THESE WITH YOUR ACTUAL SUPABASE DETAILS !!!
        const SUPABASE_URL = 'https://dyrsbfrvonajerbfrxzw.supabase.co'; 
        const SUPABASE_AUTH_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5cnNiZnJ2b25hamVyYmZyeHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDk0ODAsImV4cCI6MjA3NTMyNTQ4MH0.mgj9f_ROkti_I3CeJ4ebYVhaLGy9Wamvj4XTtH_rB_I';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_AUTH_KEY);
        
        const PRODUCTS_TABLE = 'products';
        const STORAGE_BUCKET = 'market-images'; 
        
        let allProducts = [];
        let filteredProducts = []; // Stores products after search/category filter
        let currentPage = 1;
        const productsPerPage = 10;
        
        // =================================================================================
        
        // --- DOM ELEMENTS & MODAL FUNCTIONS ---
        const modal = document.getElementById('sellProductModal');
        const searchInput = document.getElementById('searchInput');
        const filterPillsContainer = document.getElementById('filterPillsContainer');
        const productGrid = document.getElementById('productGrid');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');
        const filterToggleBtn = document.getElementById('filterToggleBtn');
        
        let selectedCategory = ''; // Global state for category filtering

        function openSellModal() { modal.style.display = 'block'; }
        function closeSellModal() { modal.style.display = 'none'; }
        window.onclick = (event) => { if (event.target == modal) { closeSellModal(); } }
        
        // ** Helper Functions (compressImage, sanitizeFilename, displayMessage are reused) **
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = (event) => {
                    const img = new Image();
                    img.onerror = reject;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200; 
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height = height * (MAX_WIDTH / width);
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg'
                            });
                            resolve(compressedFile);
                        }, 'image/jpeg', 0.4); 
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function sanitizeFilename(name){ 
            const idx = name.lastIndexOf('.'); 
            const base = idx === -1 ? name : name.slice(0, idx); 
            const ext = idx === -1 ? '' : name.slice(idx); 
            const safe = base 
                .normalize('NFKD') 
                .replace(/[^\w\s-]/g, '') 
                .trim() 
                .replace(/\s+/g, '-') 
                .replace(/-+/g,'-'); 
            return `${safe}${ext}`; 
        }

        function displayMessage(text, className, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            // Clear previous class and set new one
            messageDiv.className = '';
            messageDiv.classList.add(className);
            messageDiv.style.display = 'block';
            if (!isError) {
                 setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
            }
        }

        // =================================================================================
        // --- PRODUCT LISTING LOGIC (Unchanged) ---
        // =================================================================================
        document.getElementById('productForm').addEventListener('submit', async function(event) {
            event.preventDefault(); 

            const productName = document.getElementById('productName').value;
            const category = document.getElementById('category').value;
            const condition = document.getElementById('condition').value;
            const price = parseFloat(document.getElementById('price').value);
            const isNegotiable = document.getElementById('isNegotiable').checked;
            const description = document.getElementById('description').value;
            const location = document.getElementById('location').value;
            let whatsappNumber = document.getElementById('whatsappNumber').value; 
            const imageFile = document.getElementById('imageFile').files[0];
            
            const submitButton = document.getElementById('submitButton');
            
            if (!productName || !description || isNaN(price) || price < 0 || !imageFile || !category || !condition || !location || !whatsappNumber) {
                displayMessage('All required fields must be filled.', 'error', true);
                return;
            }

            // --- WHATSAPP NUMBER SANITIZATION & PREFIXING ---
            whatsappNumber = whatsappNumber.replace(/[^0-9+]/g, '');
            if (whatsappNumber.startsWith('0')) {
                whatsappNumber = `+234${whatsappNumber.substring(1)}`;
            } else if (!whatsappNumber.startsWith('+234')) {
                 whatsappNumber = `+234${whatsappNumber}`;
            }
            
            submitButton.disabled = true;
            displayMessage('Listing product...', 'warning');

            let imageUrl = null;
            
            try {
                // 1. --- IMAGE FILE UPLOAD LOGIC ---
                displayMessage('Compressing and uploading product image...', 'warning');

                const compressedImage = await compressImage(imageFile);
                const safeFileName = sanitizeFilename(compressedImage.name);
                const filePath = `images/${Date.now()}-${safeFileName}`; 
                
                const { error: uploadError } = await supabase.storage
                    .from(STORAGE_BUCKET) 
                    .upload(filePath, compressedImage, { cacheControl: '3600', upsert: false });

                if (uploadError) {
                    throw new Error(`STORAGE UPLOAD FAILED (Image): ${uploadError.message}.`); 
                }

                const { data: publicUrlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);
                imageUrl = publicUrlData.publicUrl;
                
                // 2. --- DATABASE INSERT LOGIC ---
                const productData = {
                    name: productName, 
                    price: price,
                    location: location,
                    whatsapp_number: whatsappNumber,
                    is_negotiable: isNegotiable,
                    condition: condition,
                    category: category,
                    description: description, 
                    image_url: imageUrl,
                };

                const { error: insertError } = await supabase
                    .from(PRODUCTS_TABLE) 
                    .insert([productData]);

                if (insertError) {
                    const specificError = insertError.message.includes('RLS')
                        ? `DB INSERT FAILED: RLS policy on '${PRODUCTS_TABLE}' denied the request.`
                        : `DB INSERT FAILED: ${insertError.message}`;
                    
                    throw new Error(specificError);
                }

                displayMessage(`Product "${productName}" successfully listed!`, 'success');
                document.getElementById('productForm').reset();
                closeSellModal();
                await fetchProducts(); 
                
            } catch (error) {
                console.error('Final Listing Error:', error);
                
                const displayMessageText = error.message.includes('RLS') || error.message.includes('STORAGE') || error.message.includes('DB INSERT')
                    ? error.message 
                    : `An unknown error occurred: ${error.message}`;

                displayMessage(displayMessageText, 'error', true);
            } finally {
                submitButton.disabled = false;
            }
        });

        // =================================================================================
        // --- NEW SHARE FUNCTIONALITY ---
        // =================================================================================
        /**
 * Shares product details using the Web Share API or falls back to clipboard copy.
 * Shares the specific product details page link.
 * * @param {string} productName 
 * @param {number} productPrice 
 * @param {number} productId - The ID to construct the unique product URL.
 */
function shareProduct(productName, productPrice, productId) {
    // 1. Construct the specific URL for this product details page
    const productDetailUrl = window.location.origin + '/productdetails.html?id=' + productId; 
    
    // 2. Create the text content *WITHOUT* the URL
    // The sharing application will automatically append the URL from the 'url' field.
    const text = `🔥 Check out this item on EKSU Market:\n*${productName}*\nPrice: ₦${productPrice.toLocaleString()}`;
    const title = `EKSU Market: ${productName}`;
    
    // 3. Web Share API (Preferred for Mobile)
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text, // Custom message body (no duplicate URL)
            url: productDetailUrl // Dedicated URL field
        }).then(() => {
            console.log('Successful share');
        }).catch((error) => {
            console.log('Share action cancelled or failed:', error);
        });
    } else {
        // 4. Manual Fallback for Desktops (MUST include the link in the text for clipboard copy)
        const fallbackText = `${text}\nView details here: ${productDetailUrl}`;
        navigator.clipboard.writeText(fallbackText).then(() => {
            alert('Product details (name, price, and link) copied to clipboard! You can now paste and share.');
        }).catch(err => {
            console.error('Could not copy text: ', err);
            alert('Could not copy product details. Your browser may not support clipboard access.');
        });
    }
}

       

        // =================================================================================
        // --- PRODUCT FETCHING, FILTERING, RENDERING & PAGINATION LOGIC ---
        // =================================================================================
        
        async function fetchProducts() {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            const { data: products, error } = await supabase
                .from(PRODUCTS_TABLE)
                .select('*')
                .order('id', { ascending: false });

            loading.style.display = 'none';

            if (error) {
                console.error('Error fetching products:', error);
                displayMessage(`Error loading products: ${error.message}`, 'error', true);
                return;
            }

            allProducts = products || []; 
            // Reset page on fresh fetch
            currentPage = 1;
            applyFiltersAndPagination(); 
        }
        
        function applyFiltersAndPagination() {
            // 1. Apply Search and Category Filter
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            filteredProducts = allProducts.filter(product => {
                const searchMatch = product.name.toLowerCase().includes(searchTerm) ||
                                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                                    (product.location && product.location.toLowerCase().includes(searchTerm));

                const categoryMatch = !selectedCategory || product.category === selectedCategory;
                
                return searchMatch && categoryMatch;
            });
            
            // 2. Render Current Page
            renderCurrentPage();
        }
        
        function renderCurrentPage() {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            
            // Ensure currentPage doesn't exceed totalPages (or is at least 1)
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (currentPage < 1 && totalPages > 0) {
                 currentPage = 1;
            } else if (totalPages === 0) {
                currentPage = 1; // Display page 1 of 0 if no results
            }

            const start = (currentPage - 1) * productsPerPage;
            const end = start + productsPerPage;
            const productsToShow = filteredProducts.slice(start, end);
            
            productGrid.innerHTML = '';
            
            if (productsToShow.length === 0 && filteredProducts.length > 0) {
                 // Should only happen if the filtering is wrong, but as a fallback
                 productGrid.innerHTML = '<p style="text-align:center; padding: 20px; width: 100%;">No products found on this page.</p>';
            } else if (filteredProducts.length === 0) {
                productGrid.innerHTML = '<p style="text-align:center; padding: 20px; width: 100%;">No products match your current search/filter criteria.</p>';
                pageInfo.textContent = 'Page 0 of 0';
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                return;
            }

            productsToShow.forEach(renderProductCard);
            updatePaginationControls(totalPages);
        }

        function updatePaginationControls(totalPages) {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            // Scroll to the top of the product grid on page change
            productGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        /**
         * Renders an individual product card with the new Share button.
         * @param {object} product 
         */
        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const imageSrc = product.image_url || 'https://via.placeholder.com/400x200?text=EKSU+MARKET'; 
            
            let conditionTagClass = 'tag-new';
            if (product.condition && product.condition.includes('Used')) {
                conditionTagClass = 'tag-used';
            }

            const cleanNumber = product.whatsapp_number ? product.whatsapp_number.replace(/[^\d+]/g, '') : '';
            const whatsappLink = cleanNumber 
                ? `https://wa.me/${cleanNumber}?text=Hello!%20I%20am%20interested%20in%20your%20product:%20${encodeURIComponent(product.name)}.`
                : '#'; 
            
            // Prepare product data for the share function call
            // Escape single quotes in name for the string passed to onclick
            const productName = product.name ? product.name.replace(/'/g, "\\'") : ''; 
            const productPrice = product.price || 0;
            const productImageUrl = product.image_url || '';
            
            // Build the JavaScript function call string for the onclick event
            const shareOnClick = `shareProduct('${productName}', ${productPrice}, '${productImageUrl}')`;


            card.innerHTML = `
                <img src="${imageSrc}" alt="${product.name}">
                <div class="product-info">
                    <h2>${product.name}</h2>
                    <div class="tag-row">
                        <span class="product-tag">${product.category || 'Uncategorized'}</span>
                        <span class="product-tag ${conditionTagClass}">${product.condition || 'Unknown'}</span>
                        ${product.is_negotiable ? '<span class="product-tag tag-neg">NEGOTIABLE</span>' : ''}
                    </div>
                    
                    <span class="product-price">₦${product.price ? product.price.toLocaleString() : '0'}</span>
                    
                    <span class="tag-location">📍 ${product.location || 'Unknown Location'}</span>

                    <div class="action-btns">
                        <button class="action-btn share-btn" onclick="${shareOnClick}" aria-label="Share ${product.name}">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    
                        <a href="${whatsappLink}" target="_blank" class="action-btn whatsapp-btn" ${cleanNumber ? '' : 'disabled'} >
                            <i class="fa fa-shopping-cart"></i> BUY
                        </a>
                    </div>
                </div>
            `;
            productGrid.appendChild(card);
        }

        // =================================================================================
        // --- EVENT LISTENERS ---
        // =================================================================================
        
        // Search Input Listener
        searchInput.addEventListener('input', () => {
             currentPage = 1; // Reset to page 1 on new search
             applyFiltersAndPagination();
        });
        
        // Filter Pills Listener
        filterPillsContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('filter-pill')) {
                // Remove 'active' from all pills
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                
                // Set 'active' on the clicked pill
                target.classList.add('active');
                
                // Update global category state
                selectedCategory = target.getAttribute('data-category');
                
                currentPage = 1; // Reset to page 1 on new filter
                applyFiltersAndPagination();
            }
        });
        
        // Pagination Listeners
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
            }
        });

        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderCurrentPage();
            }
        });
        
        // Toggle Filters on Mobile
        filterToggleBtn.addEventListener('click', () => {
            const pills = document.getElementById('filterPillsContainer');
            // Simple toggle for mobile view if the user clicks the filter icon
            if (window.innerWidth < 768) {
                pills.style.display = pills.style.display === 'flex' ? 'none' : 'flex';
                // Adjust for overflow-x on toggle
                pills.style.flexWrap = pills.style.display === 'flex' ? 'wrap' : 'nowrap';
            }
        });

        // Initialize the page
        fetchProducts();
        
    </script>
</body>
</html>
